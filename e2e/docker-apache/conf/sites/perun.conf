<VirtualHost *:80>

  ServerAdmin perun@cesnet.cz
  ServerName perun-rpc.org

  DocumentRoot /var/www

  # Note: buffer size must be set also in Tomcat and must be lower then this value.
  ProxyIOBufferSize 65536

  #### SECURITY

  # HTTP tracing
  TraceEnable off
  # https://scotthelme.co.uk/hardening-your-http-response-headers/#x-frame-options
  Header always set X-Frame-Options DENY
  # https://scotthelme.co.uk/hsts-the-missing-link-in-tls/
  Header always set Strict-Transport-Security "max-age=63072000"
  # https://scotthelme.co.uk/hardening-your-http-response-headers/#x-content-type-options
  Header always set X-Content-Type-Options nosniff
  # https://scotthelme.co.uk/hardening-your-http-response-headers/#x-xss-protection
  Header always set X-XSS-Protection "1; mode=block"
  # https://scotthelme.co.uk/content-security-policy-an-introduction/
  Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/  ; frame-src https://www.google.com/recaptcha/  ; style-src 'self' 'unsafe-inline' ; font-src 'self'  ; img-src 'self' data:  ; ; connect-src 'self' "
  # https://scotthelme.co.uk/a-new-security-header-referrer-policy/
  Header always set Referrer-Policy "no-referrer-when-downgrade"
  # https://scotthelme.co.uk/a-new-security-header-feature-policy/
  Header always set Feature-Policy "microphone 'none'; camera 'none'; geolocation 'none'; payment 'none'"

  # Disable browser caching for our html/rpc resources
  Header always set Cache-Control "no-cache, no-store, max-age=0, must-revalidate" "expr=%{REQUEST_URI} =~ m#^/(.*)/((gui|pwd-reset|wui|ic|registrar|publications|profile|affiliation)(/|(.*).nocache.js)|rpc/(.*))$#"
  Header always set Pragma no-cache "expr=%{REQUEST_URI} =~ m#^/(.*)/((gui|pwd-reset|wui|ic|registrar|publications|profile|affiliation)(/|(.*).nocache.js)|rpc/(.*))$#"
  Header always set Expires 0 "expr=%{REQUEST_URI} =~ m#^/(.*)/((gui|pwd-reset|wui|ic|registrar|publications|profile|affiliation)(/|(.*).nocache.js)|rpc/(.*))$#"

  #### REWRITE

  RewriteEngine On

  ####################################
  ##     RPC                      ####
  ####################################

  <Proxy "ajp://perun-rpc:8009/">
    ProxySet secret=test
  </Proxy>
  # General rewrite rule
   RewriteRule ^/(.*)/rpc/(.*)$ ajp://perun-rpc:8009/perun-rpc/$2 [P,QSA]

  # HTTP Basic Authentication with username and password
  <LocationMatch "^/ba/">
    Options FollowSymLinks
    AuthType basic
    AuthName "Perun RPC"
    <LimitExcept OPTIONS>
        Require valid-user
    </LimitExcept>
    AuthBasicProvider file
    AuthUserFile /usr/local/apache2/perun.passwd
    SetEnvIf _ .* AJP_EXTSOURCE=INTERNAL
    SetEnvIf _ .* AJP_EXTSOURCETYPE=cz.metacentrum.perun.core.impl.ExtSourceInternal
    SetEnvIf _ .* AJP_EXTSOURCELOA=0
  </LocationMatch>
</VirtualHost>
