<div class="d-flex flex-row align-items-center gap-4">
  <mat-form-field class="w-100 pb-0" subscriptSizing="dynamic">
    <mat-label>{{selectPlaceholder}}</mat-label>
    <mat-select
      [required]="required"
      data-cy="search-select-input"
      (openedChange)="openChange()"
      (closed)="closeChange()"
      [formControl]="entitiesCtrl"
      [multiple]="multiple">
      @if (multiple) {
        <mat-select-trigger>
          {{multipleSelectedText()}}
        </mat-select-trigger>
      }
      @if (!multiple && entitiesCtrl?.value) {
        <mat-select-trigger>
          {{mainTextFunction(entitiesCtrl?.value)}}
          <span class="text-muted">{{secondaryTextFunction(entitiesCtrl?.value)}}</span>
        </mat-select-trigger>
      }
      <mat-option>
        <ngx-mat-select-search
          data-cy="find-input"
          placeholderLabel="{{findPlaceholder}}"
          noEntriesFoundLabel="{{noEntriesText}}"
          [clearSearchInput]="false"
          [formControl]="entityFilterCtrl">
        </ngx-mat-select-search>
      </mat-option>
      @if (entitiesCtrl?.value) {
        <mat-option
          class="selected-options-bottom"
          [value]="entitiesCtrl?.value"
          (onSelectionChange)="onChange($event)">
          {{mainTextFunction(entitiesCtrl?.value)}}
          <span class="text-muted">{{secondaryTextFunction(entitiesCtrl?.value)}}</span>
          @if (displayStatus) {
            <span class="{{colorByStatus(entitiesCtrl?.value)}}">
              {{statusTextFunction(entitiesCtrl?.value) ? '('+statusTextFunction(entitiesCtrl?.value)+')' : ''}}
            </span>
          }
        </mat-option>
      }
      <cdk-virtual-scroll-viewport
        itemSize="48"
        [style.height.px]="getViewportHeight()"
        #scrollViewport
        [minBufferPx]="5 * 48"
        [maxBufferPx]="10 * 48">
        <mat-option
          class="{{highlightOption && !entity ? 'fst-italic ' + theme : theme}}"
          *cdkVirtualFor="let entity of filteredEntities | async"
          [value]="entity"
          (onSelectionChange)="onChange($event)">
          {{mainTextFunction(entity)}}
          <span class="text-muted">{{secondaryTextFunction(entity)}}</span>
          @if (displayStatus) {
            <span class="{{colorByStatus(entity)}}">
              {{statusTextFunction(entity) ? '('+statusTextFunction(entity)+')' : ''}}
            </span>
          }
        </mat-option>
      </cdk-virtual-scroll-viewport>
    </mat-select>
    @if (hint?.length !== 0) {
      <mat-hint>{{hint}}</mat-hint>
    }
  </mat-form-field>

  @if (!disableDeselectButton) {
    <perun-web-apps-deselect-button
      [isDisabled]="selectedEntities.length === 0"
      (deselect)="deselectEvent()">
    </perun-web-apps-deselect-button>
  }
</div>
