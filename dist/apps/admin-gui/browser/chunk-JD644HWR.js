import{Ad as B,Ae as Xe,Ba as L,Be as Ye,Bg as $,Ca as y,Cc as Y,Ce as Ze,Cg as et,Da as n,Dc as Z,Ed as V,Eg as tt,Fg as ve,Fj as nt,G as D,H as T,Ha as Me,Hd as oe,Ia as Pe,Id as ne,Ja as Oe,K as N,Ka as E,Kd as Ve,Ki as it,Lb as Te,Li as pe,Ma as Fe,Md as ae,Na as b,Oa as J,Of as k,Pa as x,Qd as se,S as A,Sd as le,Sj as at,T as I,Vi as de,Wa as we,Xa as je,Ya as K,Za as g,aa as a,bd as ee,cb as d,cd as te,d as q,db as h,ea as l,eb as H,ed as Ne,ee as We,fa as O,fb as Q,fd as Le,fe as W,ge as U,gj as me,h as j,he as re,ib as X,id as Ge,ie as Ue,jd as ze,je as ke,k as xe,ka as S,ke as $e,kj as Ce,l as he,la as G,ld as Be,le as He,me as Qe,mf as fe,nc as z,nj as ot,o as ge,pb as De,qa as u,qi as ce,ra as _,sa as Ae,ta as Ie,tb as F,ua as Ee,ug as P,va as m,wa as s,we as qe,x as Se,xa as p,xd as ie,xe as Je,ya as R,ye as Ke}from"./chunk-353QRQI4.js";var ft=()=>["checkbox","id","shortName","name"],vt=()=>["select","id","vo","name","description"],Ct=()=>["select","id","name","description"],Rt=()=>["select","id","name"];function bt(i,c){i&1&&R(0,"perun-web-apps-loading-dialog")}function yt(i,c){if(i&1){let e=L();s(0,"perun-web-apps-debounce-filter",13),y("filter",function(o){A(e);let r=n(2);return I(r.applyFilter(o))}),p()}i&2&&m("placeholder","SHARED_LIB.PERUN.COMPONENTS.UNIVERSAL_OBJECTS_LIST.FILTER")}function xt(i,c){if(i&1&&(R(0,"perun-web-apps-vos-list",6),d(1,"manageableEntities"),d(2,"unassignedRole")),i&2){let e=n(2);m("loading",e.loading)("filterValue",e.filterValue)("vos",Q(2,10,H(1,7,e.vos,e.selectedRule),e.roles,e.selectedRule))("displayedColumns",g(14,ft))("selection",e.selected)("cachedSubject",e.cachedSubject)("disableRouting",!0)}}function St(i,c){if(i&1&&(R(0,"perun-web-apps-groups-list",7),d(1,"manageableEntities"),d(2,"unassignedRole")),i&2){let e=n(2);m("loading",e.loading)("groups",Q(2,9,H(1,6,e.groups,e.selectedRule),e.roles,e.selectedRule))("displayedColumns",g(13,vt))("selection",e.selected)("filter",e.filterValue)("disableRouting",!0)}}function At(i,c){if(i&1&&(R(0,"perun-web-apps-facilities-list",8),d(1,"extractFacility"),d(2,"manageableEntities"),d(3,"unassignedRole"),d(4,"toEnrichedFacility")),i&2){let e=n(2);m("filterValue",e.filterValue)("facilities",h(4,16,Q(3,12,H(2,9,h(1,7,e.facilities),e.selectedRule),e.roles,e.selectedRule)))("displayedColumns",g(18,Ct))("selection",e.selectedFacilities)("cachedSubject",e.cachedSubject)("loading",e.loading)("disableRouting",!0)}}function It(i,c){if(i&1&&(R(0,"perun-web-apps-resources-list",9),d(1,"manageableEntities"),d(2,"unassignedRole")),i&2){let e=n(2);m("filterValue",e.filterValue)("loading",e.loading)("resources",Q(2,10,H(1,7,e.resources,e.selectedRule),e.roles,e.selectedRule))("displayedColumns",g(14,Rt))("selection",e.selected)("cachedSubject",e.cachedSubject)("disableRouting",!0)}}function Et(i,c){if(i&1){let e=L();s(0,"div")(1,"div",2)(2,"h1",2),b(3),d(4,"translate"),p()(),s(5,"div",3)(6,"perun-web-apps-role-search-select",4),y("roleSelected",function(o){A(e);let r=n();return I(r.resetSelection(o))}),p(),u(7,yt,1,1,"perun-web-apps-debounce-filter",5),u(8,xt,3,15,"perun-web-apps-vos-list",6),u(9,St,3,14,"perun-web-apps-groups-list",7),u(10,At,5,19,"perun-web-apps-facilities-list",8),u(11,It,3,15,"perun-web-apps-resources-list",9),p(),s(12,"div",10)(13,"button",11),y("click",function(){A(e);let o=n();return I(o.cancel())}),b(14),d(15,"translate"),p(),s(16,"button",12),y("click",function(){A(e);let o=n();return I(o.addRole())}),b(17),d(18,"translate"),p()()()}if(i&2){let e=n();a(3),J(h(4,10,"DIALOGS.ADD_ROLE.TITLE")),a(3),m("roles",e.rules),a(),_(e.selectedRule!=null&&e.selectedRule.primaryObject?7:-1),a(),_((e.selectedRule==null?null:e.selectedRule.primaryObject)==="Vo"?8:-1),a(),_((e.selectedRule==null?null:e.selectedRule.primaryObject)==="Group"?9:-1),a(),_((e.selectedRule==null?null:e.selectedRule.primaryObject)==="Facility"?10:-1),a(),_((e.selectedRule==null?null:e.selectedRule.primaryObject)==="Resource"?11:-1),a(3),x(" ",h(15,12,"DIALOGS.ADD_ROLE.CANCEL")," "),a(2),m("disabled",e.loading||e.selectedRule===null||e.selectedRule.primaryObject==="Facility"&&e.selectedFacilities.isEmpty()||e.selectedRule.primaryObject&&e.selectedRule.primaryObject!=="Facility"&&e.selected.isEmpty()),a(),x(" ",h(18,14,"DIALOGS.ADD_ROLE.ADD")," ")}}var ue=(()=>{class i{constructor(e,t,o,r,f){this.dialogRef=e,this.voService=t,this.groupService=o,this.facilityService=r,this.resourceService=f,this.loading=!1,this.submitForm=new G,this.selected=new z(!0,[],!0,(M,w)=>M.id===w.id),this.cachedSubject=new q(!0),this.selectedFacilities=new z(!0,[],!0,(M,w)=>M.facility.id===w.facility.id),this.filterValue="",this.vos=[],this.groups=[],this.facilities=[],this.resources=[]}ngOnInit(){this.selectedRule=this.rules[0],this.loadObjects()}loadObjects(){this.loading=!0,this.rules.some(e=>e.primaryObject==="Facility")&&this.facilityService.getAllFacilities().subscribe({next:e=>this.facilities=new ve().transform(e)}),this.rules.some(e=>e.primaryObject==="Vo")&&this.voService.getMyVos().subscribe({next:e=>this.vos=e}),this.groupService.getAllGroupsFromAllVos().pipe(Se(this.resourceService.getAllResources())).subscribe({next:([e,t])=>{this.groups=e,this.resources=t,this.loading=!1},error:()=>this.loading=!1})}cancel(){this.dialogRef.close(!1)}addRole(){this.selectedRule.primaryObject==="Facility"?this.submitForm.emit({role:this.selectedRule,entities:this.selectedFacilities.selected.map(e=>e.facility)}):this.submitForm.emit({role:this.selectedRule,entities:this.selected.selected})}resetSelection(e){this.selectedRule=e,this.selected.clear(),this.cachedSubject.next(!0),this.selectedFacilities.clear(),this.filterValue="",this.loadObjects(),this.filterComponent&&this.filterComponent.control.setValue("")}applyFilter(e){this.filterValue=e,this.selected.clear(),this.selectedFacilities.clear(),this.cachedSubject.next(!0)}static{this.\u0275fac=function(t){return new(t||i)(l(U),l(le),l(ne),l(oe),l(ae))}}static{this.\u0275cmp=O({type:i,selectors:[["app-add-role-dialog"]],viewQuery:function(t,o){if(t&1&&Me(Ce,5),t&2){let r;Pe(r=Oe())&&(o.filterComponent=r.first)}},inputs:{loading:"loading",rules:"rules",roles:"roles",theme:"theme"},outputs:{submitForm:"submitForm"},decls:4,vars:5,consts:[["spinner",""],[4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],["mat-dialog-title",""],["mat-dialog-content","",1,"dialog-container"],[3,"roleSelected","roles"],[1,"font-size-1rem",3,"placeholder"],[3,"loading","filterValue","vos","displayedColumns","selection","cachedSubject","disableRouting"],[3,"loading","groups","displayedColumns","selection","filter","disableRouting"],[3,"filterValue","facilities","displayedColumns","selection","cachedSubject","loading","disableRouting"],[3,"filterValue","loading","resources","displayedColumns","selection","cachedSubject","disableRouting"],["mat-dialog-actions",""],["mat-stroked-button","",1,"ms-auto",3,"click"],["color","accent","mat-flat-button","",1,"ms-2",3,"click","disabled"],[1,"font-size-1rem",3,"filter","placeholder"]],template:function(t,o){if(t&1&&(S(0,bt,1,0,"ng-template",null,0,X),s(2,"div"),S(3,Et,19,16,"div",1),p()),t&2){let r=E(1);a(2),Fe(je("",o.theme," position-relative")),a(),m("perunWebAppsLoader",o.loading)("perunWebAppsLoaderIndicator",r)}},dependencies:[F,te,ee,Qe,ke,He,$e,Be,Ce,Z,de,pe,me,ce,at,ie,Y,tt,et,$,ve],encapsulation:2})}}return i})();var lt=(()=>{class i{constructor(e,t,o,r,f,M){this.dialogRef=e,this.data=t,this.authResolver=o,this.authzService=r,this.notificator=f,this.translate=M,this.loading=!1,this.rules=this.authResolver.getAssignableRoleRules("GROUP")}addRole(e){this.loading=!0,!e.entities||e.entities.length===0?this.authzService.setRoleForGroup({role:e.role.roleName,authorizedGroup:this.data.entityId}).subscribe({next:()=>{this.showSuccess(e.role.displayName),this.dialogRef.close(!0)},error:()=>{this.loading=!1}}):this.authzService.setRoleWithGroupComplementaryObjects({role:e.role.roleName,authorizedGroup:this.data.entityId,complementaryObjects:e.entities}).subscribe({next:()=>{this.showSuccess(e.role.displayName),this.dialogRef.close(!0)},error:()=>{this.loading=!1}})}showSuccess(e){this.notificator.showSuccess(this.translate.instant("DIALOGS.ADD_ROLE.SUCCESS",{role:e}))}static{this.\u0275fac=function(t){return new(t||i)(l(U),l(re),l(W),l(V),l(k),l(B))}}static{this.\u0275cmp=O({type:i,selectors:[["app-add-group-role-dialog"]],decls:1,vars:4,consts:[[3,"submitForm","loading","rules","roles","theme"]],template:function(t,o){t&1&&(s(0,"app-add-role-dialog",0),y("submitForm",function(f){return o.addRole(f)}),p()),t&2&&m("loading",o.loading)("rules",o.rules)("roles",o.data.roles)("theme","group-theme")},dependencies:[F,ue],encapsulation:2})}}return i})();var rt=(()=>{class i{constructor(e,t,o,r,f,M,w,_e){this.dialogRef=e,this.data=t,this.authResolver=o,this.authzService=r,this.usersService=f,this.notificator=M,this.translate=w,this.displayedRole=_e,this.loading=!1,this.rules=this.authResolver.getAssignableRoleRules("USER")}ngOnInit(){this.loading=!0,this.usersService.getUserById(this.data.entityId).subscribe({next:e=>{e.serviceUser||(this.rules=this.rules.filter(t=>!t.skipMFA))},error:()=>this.loading=!1})}addRole(e){this.loading=!0,!e.entities||e.entities.length===0?this.authzService.setRoleForUser({role:e.role.roleName,user:this.data.entityId}).subscribe({next:()=>{this.showSuccess(e.role.displayName),this.dialogRef.close(!0)},error:()=>{this.loading=!1}}):this.authzService.setRoleWithUserComplementaryObjects({role:e.role.roleName,user:this.data.entityId,complementaryObjects:e.entities}).subscribe({next:()=>{this.showSuccess(e.role.displayName),this.dialogRef.close(!0)},error:()=>{this.loading=!1}})}showSuccess(e){this.notificator.showSuccess(this.translate.instant("DIALOGS.ADD_ROLE.SUCCESS",{role:e}))}static{this.\u0275fac=function(t){return new(t||i)(l(U),l(re),l(W),l(V),l(se),l(k),l(B),l(P))}}static{this.\u0275cmp=O({type:i,selectors:[["app-add-user-role-dialog"]],features:[K([P])],decls:1,vars:4,consts:[[3,"submitForm","loading","rules","theme","roles"]],template:function(t,o){t&1&&(s(0,"app-add-role-dialog",0),y("submitForm",function(f){return o.addRole(f)}),p()),t&2&&m("loading",o.loading)("rules",o.rules)("theme","user-theme")("roles",o.data.roles)},dependencies:[F,ue],encapsulation:2})}}return i})();var Pt=()=>["Vo","Group","Resource"],Ot=()=>["id","name","shortName"],Ft=()=>["checkbox","id","name","shortName"],wt=()=>["id","name","shortName","authzGroup"],jt=()=>["id","vo","name","description"],Dt=()=>["select","id","vo","name","description"],Tt=()=>["id","vo","name","description","authzGroup"],Nt=()=>["id","name","vo","facility","description"],Lt=()=>["select","id","name","vo","facility","description"],Gt=()=>["id","name","vo","facility","description","authzGroup"],zt=()=>["id","name","description"],Bt=()=>["select","id","name","description"],Vt=()=>["id","name","description","authzGroup"],Wt=()=>["id","fullName","sponsored"],Ut=()=>["user","id","name"];function kt(i,c){if(i&1){let e=L();s(0,"button",6),y("click",function(){A(e);let o=n();return I(o.addRole())}),b(1),d(2,"translate"),p()}i&2&&(a(),x(" ",h(2,1,"ROLES.ADD")," "))}function $t(i,c){i&1&&R(0,"mat-spinner",3)}function Ht(i,c){if(i&1){let e=L();s(0,"span",11),d(1,"translate"),s(2,"button",13),y("click",function(){A(e);let o=n(2).$implicit,r=n(2);return I(r.openConfirmDialog(o))}),b(3),d(4,"translate"),p()()}if(i&2){let e=n(2).$implicit,t=n(2);m("matTooltip",we(h(1,5,"ROLES.REMOVE_DISABLED_TOOLTIP")))("matTooltipDisabled",t.loading||t.selection.selected.length===0&&t.selectedFacilities.selected.length===0||!t.disableRemove),a(2),m("disabled",t.loading||e.primaryObject==="Facility"&&(t.selectedFacilities.selected.length===0||t.disableRemove)||g(9,Pt).includes(e.primaryObject)&&(t.selection.selected.length===0||t.disableRemove)),a(),x(" ",h(4,7,"ROLES.REMOVE")," ")}}function Qt(i,c){if(i&1&&(s(0,"div"),b(1),d(2,"translate"),p()),i&2){let e=n(4).$implicit,t=n(2);a(),x(" ",h(2,1,"ROLES."+e.roleName+"_VOS_"+t.entityType)," ")}}function qt(i,c){if(i&1&&(R(0,"perun-web-apps-vos-list",17),d(1,"async")),i&2){let e,t=n(4).$implicit,o=n(2);m("loading",o.loading)("displayedColumns",t.roleName==="MEMBERSHIP"?g(9,Ot):o.editable?g(10,Ft):g(11,wt))("vos",h(1,7,o.vos))("selection",o.selection)("authzVoNames",o.voNames)("voWithAuthzGroupPairs",o._complementaryObjectsWithAuthzGroups==null||(e=o._complementaryObjectsWithAuthzGroups.get(t.roleName))==null?null:e.get("vo"))("enableMasterCheckbox",!0)}}function Jt(i,c){if(i&1&&(s(0,"div",14),u(1,Qt,3,3,"div"),s(2,"div",15),S(3,qt,2,12,"perun-web-apps-vos-list",16),p()()),i&2){let e=n(5),t=E(6);a(),_(e.showDescription?1:-1),a(2),m("perunWebAppsLoader",e.loading)("perunWebAppsLoaderIndicator",t)}}function Kt(i,c){if(i&1&&(s(0,"div"),b(1),d(2,"translate"),p()),i&2){let e=n(4).$implicit,t=n(2);a(),x(" ",h(2,1,"ROLES."+e.roleName+"_GROUPS_"+t.entityType)," ")}}function Xt(i,c){if(i&1&&(R(0,"perun-web-apps-groups-list",19),d(1,"async")),i&2){let e,t=n(4).$implicit,o=n(2);m("loading",o.loading)("displayedColumns",t.roleName==="MEMBERSHIP"?g(8,jt):o.editable?g(9,Dt):g(10,Tt))("groups",h(1,6,o.groups))("selection",o.selection)("authzVoNames",o.voNames)("groupWithAuthzGroupPairs",o._complementaryObjectsWithAuthzGroups==null||(e=o._complementaryObjectsWithAuthzGroups.get(t.roleName))==null?null:e.get("group"))}}function Yt(i,c){if(i&1&&(s(0,"div",14),u(1,Kt,3,3,"div"),s(2,"div",15),S(3,Xt,2,11,"perun-web-apps-groups-list",18),p()()),i&2){let e=n(5),t=E(6);a(),_(e.showDescription?1:-1),a(2),m("perunWebAppsLoader",e.loading)("perunWebAppsLoaderIndicator",t)}}function Zt(i,c){if(i&1&&(s(0,"div"),b(1),d(2,"translate"),p()),i&2){let e=n(4).$implicit,t=n(2);a(),x(" ",h(2,1,"ROLES."+e.roleName+"_RESOURCES_"+t.entityType)," ")}}function ei(i,c){if(i&1&&(R(0,"perun-web-apps-resources-list",21),d(1,"async")),i&2){let e,t=n(4).$implicit,o=n(2);m("resources",h(1,7,o.resources))("displayedColumns",t.roleName==="MEMBERSHIP"?g(9,Nt):o.editable?g(10,Lt):g(11,Gt))("routingVo",!0)("selection",o.selection)("authzVoNames",o.voNames)("loading",o.loading)("resourceWithAuthzGroupPairs",o._complementaryObjectsWithAuthzGroups==null||(e=o._complementaryObjectsWithAuthzGroups.get(t.roleName))==null?null:e.get("resource"))}}function ti(i,c){if(i&1&&(s(0,"div",14),u(1,Zt,3,3,"div"),s(2,"div",15),S(3,ei,2,12,"perun-web-apps-resources-list",20),p()()),i&2){let e=n(5),t=E(6);a(),_(e.showDescription?1:-1),a(2),m("perunWebAppsLoader",e.loading)("perunWebAppsLoaderIndicator",t)}}function ii(i,c){if(i&1&&(s(0,"div"),b(1),d(2,"translate"),p()),i&2){let e=n(4).$implicit,t=n(2);a(),x(" ",h(2,1,"ROLES."+e.roleName+"_FACILITIES_"+t.entityType)," ")}}function oi(i,c){if(i&1&&(R(0,"perun-web-apps-facilities-list",23),d(1,"async")),i&2){let e,t=n(4).$implicit,o=n(2);m("loading",o.loading)("displayedColumns",t.roleName==="MEMBERSHIP"?g(9,zt):o.editable?g(10,Bt):g(11,Vt))("facilities",h(1,7,o.facilities))("selection",o.selectedFacilities)("authzVoNames",o.voNames)("facilityWithAuthzGroupPairs",o._complementaryObjectsWithAuthzGroups==null||(e=o._complementaryObjectsWithAuthzGroups.get(t.roleName))==null?null:e.get("facility"))("enableMasterCheckbox",!0)}}function ni(i,c){if(i&1&&(s(0,"div",14),u(1,ii,3,3,"div"),s(2,"div",15),S(3,oi,2,12,"perun-web-apps-facilities-list",22),p()()),i&2){let e=n(5),t=E(6);a(),_(e.showDescription?1:-1),a(2),m("perunWebAppsLoader",e.loading)("perunWebAppsLoaderIndicator",t)}}function ai(i,c){if(i&1&&(s(0,"div"),b(1),d(2,"translate"),p()),i&2){let e=n(4).$implicit,t=n(2);a(),x(" ",h(2,1,"ROLES."+e.roleName+"_MEMBERS_"+t.entityType)," ")}}function si(i,c){if(i&1&&(R(0,"perun-web-apps-members-list",25),d(1,"async")),i&2){let e=n(6);m("loading",e.loading)("displayedColumns",g(5,Wt))("members",h(1,3,e.members))}}function li(i,c){if(i&1&&(s(0,"div",14),u(1,ai,3,3,"div"),s(2,"div",15),S(3,si,2,6,"perun-web-apps-members-list",24),p()()),i&2){let e=n(5),t=E(6);a(),_(e.showDescription?1:-1),a(2),m("perunWebAppsLoader",e.loading)("perunWebAppsLoaderIndicator",t)}}function ri(i,c){if(i&1&&(s(0,"div"),b(1),d(2,"translate"),p()),i&2){let e=n(4).$implicit,t=n(2);a(),x(" ",h(2,1,"ROLES."+e.roleName+"_USERS_"+t.entityType)," ")}}function ci(i,c){if(i&1&&(R(0,"perun-web-apps-users-list",27),d(1,"async")),i&2){let e=n(6);m("loading",e.loading)("displayColumns",g(6,Ut))("disableRouting",!0)("users",h(1,4,e.users))}}function pi(i,c){if(i&1&&(s(0,"div",14),u(1,ri,3,3,"div"),s(2,"div",15),S(3,ci,2,7,"perun-web-apps-users-list",26),p()()),i&2){let e=n(5),t=E(6);a(),_(e.showDescription?1:-1),a(2),m("perunWebAppsLoader",e.loading)("perunWebAppsLoaderIndicator",t)}}function di(i,c){if(i&1&&(s(0,"div",12),u(1,Jt,4,3,"div",14),u(2,Yt,4,3,"div",14),u(3,ti,4,3,"div",14),u(4,ni,4,3,"div",14),u(5,li,4,3,"div",14),u(6,pi,4,3,"div",14),p()),i&2){let e=n(2).$implicit;a(),_(e.primaryObject==="Vo"||e.roleName==="MEMBERSHIP"?1:-1),a(),_(e.primaryObject==="Group"||e.roleName==="MEMBERSHIP"?2:-1),a(),_(e.primaryObject==="Resource"||e.roleName==="MEMBERSHIP"?3:-1),a(),_(e.primaryObject==="Facility"||e.roleName==="MEMBERSHIP"?4:-1),a(),_(e.roleName==="SPONSORSHIP"?5:-1),a(),_(e.roleName==="SELF"?6:-1)}}function mi(i,c){if(i&1&&(u(0,Ht,5,10,"span",11),u(1,di,7,6,"div",12)),i&2){let e=n().$implicit,t=E(1),o=n(2);_(o.editable&&e.roleName!=="SELF"&&e.roleName!=="MEMBERSHIP"&&e.roleName!=="SPONSORSHIP"?0:-1),a(),_(t.expanded?1:-1)}}function ui(i,c){if(i&1){let e=L();s(0,"mat-expansion-panel",8,1),y("closed",function(){let o=A(e).$implicit,r=n(2);return r.selection.clear(),r.selectedFacilities.clear(),I(r.onPanelClosed(o.roleName))})("opened",function(){let o=A(e).$implicit,r=n(2);return r.selectedRole.next(o),I(r.onPanelOpen(o.roleName))}),s(2,"mat-expansion-panel-header")(3,"mat-panel-title")(4,"p",9),b(5),d(6,"displayedRole"),p()()(),S(7,mi,2,2,"ng-template",10),p()}if(i&2){let e=c.$implicit,t=n(2);m("expanded",t.currentlyOpenPanel===e.roleName),a(5),J(h(6,2,e))}}function _i(i,c){if(i&1&&(s(0,"mat-accordion"),Ie(1,ui,8,4,"mat-expansion-panel",7,Ae),p()),i&2){let e=n();a(),Ee(e.allRules)}}function hi(i,c){i&1&&(s(0,"perun-web-apps-alert",5),b(1),d(2,"translate"),p()),i&2&&(a(),x(" ",h(2,1,"ROLES.NO_ROLES")," "))}function gi(i,c){i&1&&(s(0,"div",28),R(1,"mat-spinner"),p())}var Yo=(()=>{class i{constructor(e,t,o,r,f,M,w,_e,ct,pt,dt,mt,ut,_t){this.authzResolverService=e,this.usersService=t,this.vosService=o,this.facilitiesService=r,this.resourcesService=f,this.groupsService=M,this.membersService=w,this.dialog=_e,this.notification=ct,this.translate=pt,this.rolePipe=dt,this.guiAuthResolver=mt,this.manageableEntities=ut,this.store=_t,this.editable=!0,this.currentlyOpenPanel=null,this.reload=new G,this.startLoading=new G,this.currentlyOpenPanelChange=new G,this.selection=new z(!0,[],!0,(v,C)=>v.id===C.id),this.selectedFacilities=new z(!0,[]),this.assignableRules=[],this.allRules=[],this.disableRemove=!1,this.voNames=new Map,this.selectedRole=new q(null),this.groups=this.selectedRole.pipe(T(v=>{this.loading=!0;let C=this.roles.get(v.roleName).get("Group");return C?.length?this.groupsService.getGroupsByIds(C):j([])}),N(()=>this.loading=!1),D([])),this.vos=this.selectedRole.pipe(T(v=>{this.loading=!0;let C=this.roles.get(v.roleName).get("Vo");return C?.length?this.vosService.getVosByIds(C):j([])}),N(()=>this.loading=!1),D([])),this.facilities=this.selectedRole.pipe(T(v=>{this.loading=!0;let C=this.roles.get(v.roleName).get("Facility");return C?.length?this.facilitiesService.getFacilitiesByIds(C):j([])}),xe(v=>v.map(C=>({facility:C}))),N(()=>this.loading=!1),D([])),this.resources=this.selectedRole.pipe(T(v=>{this.loading=!0;let C=this.roles.get(v.roleName).get("Resource");return C?.length?this.resourcesService.getRichResourcesByIds(C):j([])}),N(()=>this.loading=!1),D([])),this.members=this.selectedRole.pipe(T(v=>(this.loading=!0,this.membersService.getRichMembersByIds(this.roles.get(v.roleName).get("Member")))),N(()=>this.loading=!1),D([])),this.users=this.selectedRole.pipe(T(v=>(this.loading=!0,this.usersService.getRichUsersByIds([this.entityId].concat(this.roles.get(v.roleName).get("User"))))),N(()=>this.loading=!1),D([])),this._complementaryObjectsWithAuthzGroups=new Map,this._roles=new Map}get roles(){return this._roles}set roles(e){this._roles=e,this.allRules=this.guiAuthResolver.getAllRules().filter(t=>this._roles.has(t.roleName))}set complementaryObjectsWithAuthzGroups(e){this._complementaryObjectsWithAuthzGroups=e,this.updateVoNames()}ngOnInit(){this.assignableRules=this.guiAuthResolver.getAssignableRoleRules(this.entityType==="GROUP"?"GROUP":"USER"),this.selection.changed.subscribe(e=>{let t=e.source.selected.map(r=>{if("beanName"in r)return r}),o=this.manageableEntities.transform(t,this.selectedRole.getValue()).length;this.disableRemove=e.source.selected.length!==o}),this.selectedFacilities.changed.subscribe(e=>{let t=e.source.selected.map(r=>{if("facility"in r)return r.facility}),o=this.manageableEntities.transform(t,this.selectedRole.getValue()).length;this.disableRemove=e.source.selected.length!==o})}addRole(){let e=fe();e.width="650px",e.data={entityId:this.entityId,roles:this.roles};let t;this.entityType==="GROUP"?t=this.dialog.open(lt,e):t=this.dialog.open(rt,e),t.afterClosed().subscribe({next:o=>{o&&(this.startLoading.emit(),this.refresh())}})}openConfirmDialog(e){let t=fe(),o=this.getItems();t.width="550px",t.data={theme:this.entityType==="GROUP"?"group-theme":"user-theme",role:this.rolePipe.transform(e),entityId:this.entityId,items:o,primaryObject:this.selectedRole.getValue().primaryObject},this.dialog.open(it,t).afterClosed().subscribe({next:f=>{f&&(this.startLoading.emit(),e.primaryObject?this.removeRoleWithComplementaryObject(e):this.removeRole(e))}})}onPanelOpen(e){this.currentlyOpenPanel=e,this.currentlyOpenPanelChange.emit(e)}onPanelClosed(e){this.currentlyOpenPanel===e&&(this.currentlyOpenPanel=null,this.currentlyOpenPanelChange.emit(null))}getItems(){return this.selectedRole.getValue().primaryObject?this.selectedRole.getValue().primaryObject==="Facility"?this.selectedFacilities.selected.map(e=>e.facility):this.selection.selected.map(e=>e):[]}removeRole(e){j(this.entityType).pipe(he(t=>ge(()=>t==="GROUP",this.authzResolverService.unsetRoleForGroup({role:e.roleName,authorizedGroup:this.entityId}),this.authzResolverService.unsetRoleForUser({role:e.roleName,user:this.entityId})))).subscribe({next:()=>{this.showSuccess(e),this.refresh()},error:()=>{this.selection.clear(),this.selectedFacilities.clear(),this.outerLoading=!1}})}removeRoleWithComplementaryObject(e){let t;this.selection.selected.length!==0&&"beanName"in this.selection.selected[0]?(t=this.selection.selected,t[0].beanName==="RichResource"&&(t=t.map(o=>this.parseResource(o)))):this.selectedFacilities.selected.length!==0&&"facility"in this.selectedFacilities.selected[0]&&(t=this.selectedFacilities.selected.map(o=>this.parseFacility(o))),j(this.entityType).pipe(he(o=>ge(()=>o==="GROUP",this.authzResolverService.unsetRoleWithGroupComplementaryObjects({role:e.roleName,complementaryObjects:t,authorizedGroup:this.entityId}),this.authzResolverService.unsetRoleWithUserComplementaryObjects({role:e.roleName,complementaryObjects:t,user:this.entityId})))).subscribe({next:()=>{this.showSuccess(e),this.refresh()},error:()=>{this.selection.clear(),this.selectedFacilities.clear(),this.outerLoading=!1,this.refresh()}})}showSuccess(e){this.notification.showSuccess(this.translate.instant("ROLES.REMOVE_SUCCESS",{role:this.rolePipe.transform(e)}))}refresh(){this.selection.clear(),this.selectedFacilities.clear(),setTimeout(()=>{this.reload.emit()},500)}parseFacility(e){return e.facility}parseResource(e){return{beanName:"Resource",id:e.id,description:e.description,createdByUid:e.createdByUid,createdAt:e.createdAt,facilityId:e.facilityId,createdBy:e.createdBy,modifiedAt:e.modifiedAt,modifiedBy:e.modifiedBy,name:e.name,uuid:e.uuid,voId:e.voId,modifiedByUid:e.modifiedByUid}}updateVoNames(){let e=new Set;this._complementaryObjectsWithAuthzGroups.forEach(t=>{t.forEach(o=>{o.forEach(r=>{r.forEach(f=>{!e.has(f.voId)&&!this.voNames.has(f.voId)&&e.add(f.voId)})})})}),e.size>0&&this.vosService.getVosByIds([...e]).subscribe(t=>{t.forEach(o=>{this.voNames.set(o.id,o.name)})})}static{this.\u0275fac=function(t){return new(t||i)(l(V),l(se),l(le),l(oe),l(ae),l(ne),l(Ve),l(Ue),l(k),l(B),l(P),l(W),l($),l(We))}}static{this.\u0275cmp=O({type:i,selectors:[["app-perun-web-apps-roles-page"]],inputs:{outerLoading:"outerLoading",showDescription:"showDescription",entityId:"entityId",entityType:"entityType",editable:"editable",currentlyOpenPanel:"currentlyOpenPanel",roles:"roles",complementaryObjectsWithAuthzGroups:"complementaryObjectsWithAuthzGroups"},outputs:{reload:"reload",startLoading:"startLoading",currentlyOpenPanelChange:"currentlyOpenPanelChange"},features:[K([P,$])],decls:7,vars:4,consts:[["spinner",""],["panel",""],["mat-flat-button","","color","accent",1,"me-2","mt-2"],[1,"ms-auto","me-auto"],[1,"mt-3"],["alert_type","warn"],["mat-flat-button","","color","accent",1,"me-2","mt-2",3,"click"],[3,"expanded"],[3,"closed","opened","expanded"],[1,"mt-auto","mb-auto"],["matExpansionPanelContent",""],["matTooltipPosition","left",3,"matTooltip","matTooltipDisabled"],[1,"position-relative"],["mat-flat-button","","color","warn",1,"mt-2",3,"click","disabled"],[1,"mb-3"],[1,"position-relative","table-min-height"],[3,"loading","displayedColumns","vos","selection","authzVoNames","voWithAuthzGroupPairs","enableMasterCheckbox",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[3,"loading","displayedColumns","vos","selection","authzVoNames","voWithAuthzGroupPairs","enableMasterCheckbox"],[3,"loading","displayedColumns","groups","selection","authzVoNames","groupWithAuthzGroupPairs",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[3,"loading","displayedColumns","groups","selection","authzVoNames","groupWithAuthzGroupPairs"],[3,"resources","displayedColumns","routingVo","selection","authzVoNames","loading","resourceWithAuthzGroupPairs",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[3,"resources","displayedColumns","routingVo","selection","authzVoNames","loading","resourceWithAuthzGroupPairs"],[3,"loading","displayedColumns","facilities","selection","authzVoNames","facilityWithAuthzGroupPairs","enableMasterCheckbox",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[3,"loading","displayedColumns","facilities","selection","authzVoNames","facilityWithAuthzGroupPairs","enableMasterCheckbox"],[3,"loading","displayedColumns","members",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[3,"loading","displayedColumns","members"],[3,"loading","displayColumns","disableRouting","users",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[3,"loading","displayColumns","disableRouting","users"],[1,"spinner-container"]],template:function(t,o){t&1&&(u(0,kt,3,3,"button",2),u(1,$t,1,0,"mat-spinner",3),s(2,"div",4),u(3,_i,3,0,"mat-accordion"),p(),u(4,hi,3,3,"perun-web-apps-alert",5),S(5,gi,2,0,"ng-template",null,0,X)),t&2&&(_(o.assignableRules.length!==0&&o.editable?0:-1),a(),_(o.outerLoading?1:-1),a(2),_(!o.outerLoading&&o.roles.size>0?3:-1),a(),_(!o.outerLoading&&o.roles.size===0?4:-1))},dependencies:[F,te,ee,ze,Ge,ot,Ze,Ye,Je,Ke,Xe,qe,Le,Ne,Z,Te,de,me,nt,ce,pe,ie,De,Y,P],styles:[".role-content[_ngcontent-%COMP%]{overflow:auto;overflow-y:hidden}.info-icon[_ngcontent-%COMP%]{vertical-align:middle;transform:scale(.8)}"],changeDetection:0})}}return i})();export{Yo as a};
