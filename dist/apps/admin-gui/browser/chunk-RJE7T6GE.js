import{a as Yt}from"./chunk-VM4AM6WQ.js";import{a as X}from"./chunk-34GH45LA.js";import{$c as ce,Ad as gt,Af as Ge,Ba as A,Bc as ae,Ca as h,Cc as x,Da as _,Dc as D,Dg as wt,Ej as Gt,Fd as Ct,G as et,Gi as Vt,H as tt,Hd as V,Hj as ke,Ij as Ut,K as it,Ka as F,Ki as Ot,La as te,Lb as st,Lc as dt,Li as Z,Ma as ie,Md as Ve,Mi as Pt,Na as m,Oa as y,Od as Oe,Of as z,Pa as S,Qb as Re,Qd as vt,Rb as ve,Rh as Lt,S as u,Sb as re,Sc as j,Sd as St,T as f,Ta as be,Tc as Me,Ua as ye,Ue as At,Ui as Bt,V as B,Va as Ae,Ve as It,Wa as He,Wb as N,Wc as G,Xa as Ie,Xc as se,Xf as $,Xg as K,Yb as lt,Yc as U,Yg as Ft,Za as Ee,Zc as le,Ze as $e,_ as rt,_a as qe,_b as oe,_c as mt,_g as Mt,_i as Ue,aa as o,bd as k,bj as Nt,cb as p,cd as W,d as P,db as d,de as bt,df as Et,ea as l,eb as ze,ec as we,ee as yt,fa as E,fe as H,fj as jt,fk as kt,gd as ut,ge as pe,hd as ft,he as de,hh as xt,hk as Wt,ib as M,ic as ct,id as ht,ie as me,jb as Te,jc as ne,jd as _t,je as Pe,jj as J,k as Xe,ka as I,kd as Y,ke as Be,ld as xe,le as Ne,me as je,mf as q,nc as Fe,ob as nt,pb as at,qa as T,r as Qe,ra as R,rf as Tt,sa as ot,sf as Rt,ta as Q,tb as w,td as De,ua as ee,ud as Le,va as c,wa as a,wh as Dt,xa as n,xd as L,ya as b,zc as pt}from"./chunk-FCYS6PEK.js";var ii=(i,C)=>C.id;function ri(i,C){i&1&&b(0,"perun-web-apps-loading-dialog")}function oi(i,C){i&1&&(a(0,"mat-error"),m(1),p(2,"translate"),n()),i&2&&(o(),S(" ",d(2,1,"DIALOGS.NAME_SPACE_ERROR")," "))}function ni(i,C){i&1&&(a(0,"mat-error"),m(1),p(2,"translate"),n()),i&2&&(o(),y(d(2,1,"DIALOGS.CREATE_FACILITY.REQUIRE_NAME")))}function ai(i,C){if(i&1){let e=A();a(0,"mat-option",15),h("click",function(){let t=u(e).$implicit,s=_(2);return f(s.srcFacility=t)}),m(1),n()}if(i&2){let e=C.$implicit;c("value",e),o(),S(" ",e.name," ")}}function si(i,C){if(i&1){let e=A();a(0,"div")(1,"h1",2),m(2),p(3,"translate"),n(),a(4,"div",3)(5,"mat-form-field")(6,"mat-label"),m(7),p(8,"translate"),n(),b(9,"input",4),T(10,oi,3,3,"mat-error"),T(11,ni,3,3,"mat-error"),n(),a(12,"mat-form-field")(13,"mat-label"),m(14),p(15,"translate"),n(),b(16,"input",5),n(),a(17,"mat-form-field")(18,"mat-label"),m(19),p(20,"translate"),n(),a(21,"mat-select",6)(22,"mat-option",7),h("click",function(){u(e);let t=_();return f(t.srcFacility=null)}),m(23),p(24,"translate"),n(),Q(25,ai,2,2,"mat-option",8,ii),n()(),a(27,"perun-web-apps-alert",9),b(28,"i",10),p(29,"translate"),n()(),a(30,"div",11)(31,"button",12),h("click",function(){u(e);let t=_();return f(t.onCancel())}),m(32),p(33,"translate"),n(),a(34,"button",13),h("click",function(){u(e);let t=_();return f(t.onCreate(!0))}),m(35),p(36,"translate"),n(),a(37,"button",14),h("click",function(){u(e);let t=_();return f(t.onCreate(!1))}),m(38),p(39,"translate"),n()()()}if(i&2){let e=_();o(2),y(d(3,15,"DIALOGS.CREATE_FACILITY.TITLE")),o(5),y(d(8,17,"DIALOGS.CREATE_FACILITY.NAME")),o(2),c("formControl",e.nameControl),o(),R(e.nameControl.errors!=null&&e.nameControl.errors.spaceName?10:-1),o(),R(e.nameControl.errors!=null&&e.nameControl.errors.spaceName?-1:11),o(3),y(d(15,19,"DIALOGS.CREATE_FACILITY.DESCRIPTION")),o(2),c("formControl",e.descControl),o(3),y(d(20,21,"DIALOGS.CREATE_FACILITY.AS_COPY")),o(4),S(" ",d(24,23,"DIALOGS.CREATE_FACILITY.NO_COPY")," "),o(2),ee(e.facilities),o(3),c("innerHTML",d(29,25,"DIALOGS.CREATE_FACILITY.HINT"),rt),o(4),S(" ",d(33,27,"DIALOGS.CREATE_FACILITY.CANCEL")," "),o(2),c("disabled",e.nameControl.value.trim().length===0||!!e.srcFacility||e.loading),o(),S(" ",d(36,29,"DIALOGS.CREATE_FACILITY.CREATE_AND_CONFIGURE")," "),o(2),c("disabled",e.nameControl.value.trim().length===0||e.loading),o(),S(" ",d(39,31,"DIALOGS.CREATE_FACILITY.CREATE")," ")}}var zt=(()=>{class i{constructor(e,r,t,s,g,v,O){this.dialogRef=e,this.data=r,this.facilitiesManager=t,this.notificator=s,this.translate=g,this.router=v,this.entityStorageService=O,this.nameControl=new N("",[ve.required,Ge()]),this.descControl=new N(""),this.srcFacility=null,this.loading=!1,this.configure=!1}ngOnInit(){this.theme=this.data.theme,this.loading=!0,this.facilitiesManager.getAllFacilities().subscribe({next:e=>{this.facilities=e,this.loading=!1},error:()=>this.loading=!1})}onCreate(e){this.loading=!0,this.configure=e,this.facilitiesManager.createFacility(this.nameControl.value,this.descControl.value).subscribe({next:r=>{this.entityStorageService.setEntityAndPathParam({id:r.id,beanName:r.beanName},bt.Facility),sessionStorage.setItem("newFacilityId",String(r.id)),this.srcFacility!==null?this.copyFacilitySettings(r.id):this.handleSuccess(r.id)},error:()=>this.loading=!1})}onCancel(){this.dialogRef.close(!1)}copyFacilitySettings(e){this.facilitiesManager.copyAttributes(this.srcFacility.id,e).subscribe({next:()=>{this.facilitiesManager.copyManagers(this.srcFacility.id,e).subscribe({next:()=>{this.handleSuccess(e)},error:()=>this.loading=!1})},error:()=>this.loading=!1})}handleSuccess(e){this.notificator.showSuccess(this.translate.instant("DIALOGS.CREATE_FACILITY.SUCCESS")),this.configure&&this.router.navigate(["facilities",e.toString(),"configuration"],{queryParamsHandling:"preserve"}),this.dialogRef.close(!0)}static{this.\u0275fac=function(r){return new(r||i)(l(pe),l(de),l(V),l(z),l(ae),l(dt),l($))}}static{this.\u0275cmp=E({type:i,selectors:[["app-create-facility-dialog"]],decls:4,vars:5,consts:[["spinner",""],[4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],["mat-dialog-title",""],["mat-dialog-content","",1,"dialog-container"],["matInput","","required","","data-cy","facility-name-input",3,"formControl"],["matInput","","data-cy","facility-description-input",3,"formControl"],["disableOptionCentering","true"],[3,"click"],[3,"value"],["alert_type","info"],[3,"innerHTML"],["mat-dialog-actions",""],["mat-stroked-button","",1,"ms-auto",3,"click"],["color","accent","mat-flat-button","",1,"ml2",3,"click","disabled"],["data-cy","create-facility-button","color","accent","mat-flat-button","",1,"ml2",3,"click","disabled"],[3,"click","value"]],template:function(r,t){if(r&1&&(I(0,ri,1,0,"ng-template",null,0,M),a(2,"div"),I(3,si,40,33,"div",1),n()),r&2){let s=F(1);o(2),ie(Ie("",t.theme," position-relative")),o(),c("perunWebAppsLoader",t.loading)("perunWebAppsLoaderIndicator",s)}},dependencies:[w,W,k,U,G,j,Me,Le,De,ce,le,se,ne,Re,re,we,oe,je,Pe,Ne,Be,_t,ht,xe,D,L,x],encapsulation:2})}}return i})();var $t=(()=>{class i{constructor(e,r,t,s,g){this.dialogRef=e,this.data=r,this.facilitiesManager=t,this.notificator=s,this.translate=g,this.displayedColumns=["name"],this.loading=!1,this.relations=[],this.force=!1}ngOnInit(){this.theme=this.data.theme,this.facility=this.data.facility,this.dataSource=new pt([this.facility]),this.relations.push(this.translate.instant("DIALOGS.DELETE_FACILITY.RESOURCE_RELATION"))}onConfirm(){this.loading=!0,this.facilitiesManager.deleteFacility(this.facility.id,this.force).subscribe(()=>{this.notificator.showSuccess(this.translate.instant("DIALOGS.DELETE_FACILITY.SUCCESS")),this.dialogRef.close(!0)},()=>this.loading=!1)}onCancel(){this.dialogRef.close(!1)}onSubmit(e){this.force=e.force,e.deleted?this.onConfirm():this.onCancel()}static{this.\u0275fac=function(r){return new(r||i)(l(pe),l(de),l(V),l(z),l(ae))}}static{this.\u0275cmp=E({type:i,selectors:[["app-delete-facility-dialog"]],decls:2,vars:6,consts:[[3,"deleted","entityNames","entityType","loading","relations"]],template:function(r,t){r&1&&(a(0,"div")(1,"perun-web-apps-delete-entity-dialog",0),h("deleted",function(g){return t.onSubmit(g)}),n()()),r&2&&(ie(t.theme),o(),c("entityNames",t.dataSource)("entityType","facilities")("loading",t.loading)("relations",t.relations))},dependencies:[w,Vt],encapsulation:2})}}return i})();var ci=()=>({color:"black"}),Kt=i=>[i];function pi(i,C){if(i&1){let e=A();a(0,"button",12),p(1,"isAuthorized"),h("click",function(){u(e);let t=_();return f(t.onDelete())}),m(2),p(3,"translate"),n()}if(i&2){let e=_();c("disabled",e.loading||e.selection.selected.length===0||!ze(1,2,qe(7,Kt,e.selection.selected[0]==null?null:e.selection.selected[0].facility),"deleteFacility_Facility_Boolean_policy")),o(2),S(" ",d(3,5,"FACILITY_MANAGEMENT.DELETE")," ")}}function di(i,C){i&1&&b(0,"perun-web-apps-loading-table")}function mi(i,C){if(i&1&&b(0,"perun-web-apps-facilities-list",13),i&2){let e=_();c("tableId",e.tableId)("selection",e.selection)("cachedSubject",e.cachedSubject)("loading",e.loading)("filterValue",e.filterValue)("facilities",e.facilities)("recentIds",e.recentIds)}}var kr=(()=>{class i{static{this.id="FacilitySelectPageComponent"}constructor(e,r,t,s,g,v){this.facilityManager=e,this.sideMenuService=r,this.guiAuthResolver=t,this.dialog=s,this.cacheHelperService=g,this.destroyRef=v,this.facilities=[],this.recentIds=[],this.filterValue="",this.tableId=xt,this.selection=new Fe(!1,[],!0,(O,ge)=>O.facility.id===ge.facility.id),this.cachedSubject=new P(!0)}ngOnInit(){this.createAuth=this.guiAuthResolver.isAuthorized("createFacility_Facility_policy",[]),this.deleteAuth=this.guiAuthResolver.isFacilityAdmin(),this.refreshTable(),this.cacheHelperService.refreshComponentCachedData().pipe(K(this.destroyRef)).subscribe(e=>{e===i.id&&this.refreshTable()})}ngAfterViewChecked(){this.sideMenuService.setFacilityMenuItems([])}refreshTable(){this.loading=!0,this.facilityManager.getEnrichedFacilities().subscribe(e=>{this.selection.clear(),this.cachedSubject.next(!0),this.facilities=e,this.recentIds=Et("facilities"),this.loading=!1})}onCreate(){let e=q();e.width="800px",e.data={theme:"facility-theme"},this.dialog.open(zt,e).afterClosed().subscribe(t=>{t&&(this.loading=!0,this.refreshTable())})}onDelete(){let e=q();e.width="500px",e.data={theme:"facility-theme",facility:this.selection.selected[0].facility},this.dialog.open($t,e).afterClosed().subscribe(t=>{t&&this.refreshTable()})}applyFilter(e){this.filterValue=e,this.refreshTable()}static{this.\u0275fac=function(r){return new(r||i)(l(V),l(Wt),l(H),l(me),l(X),l(B))}}static{this.\u0275cmp=E({type:i,selectors:[["app-facility-select-page"]],hostVars:2,hostBindings:function(r,t){r&2&&te("router-component",t.true)},decls:21,vars:31,consts:[["spinner",""],[1,"container-fluid","ps-xl-5","pe-xl-5","facility-theme"],[1,"page-title","d-flex"],["svgIcon","perun-facility-black",1,"perun-icon","icon-scale",3,"ngStyle"],[3,"refresh"],["matTooltipPosition","below",3,"matTooltipDisabled","matTooltip"],["mat-flat-button","","data-cy","new-facility-button","color","accent",1,"action-button","me-2",3,"click","disabled"],[3,"matTooltipDisabled","matTooltipPosition","matTooltip"],["mat-flat-button","","data-cy","delete-facility-button","color","warn",1,"me-2",3,"disabled"],[3,"filter","autoFocus","placeholder","linkGlobalSearch"],[1,"position-relative","table-min-height"],[3,"tableId","selection","cachedSubject","loading","filterValue","facilities","recentIds",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],["mat-flat-button","","data-cy","delete-facility-button","color","warn",1,"me-2",3,"click","disabled"],[3,"tableId","selection","cachedSubject","loading","filterValue","facilities","recentIds"]],template:function(r,t){if(r&1){let s=A();a(0,"div",1),b(1,"perun-web-apps-back-button"),a(2,"h1",2),b(3,"mat-icon",3),m(4),p(5,"translate"),n(),a(6,"perun-web-apps-refresh-button",4),h("refresh",function(){return u(s),f(t.refreshTable())}),n(),a(7,"span",5),p(8,"translate"),a(9,"button",6),h("click",function(){return u(s),f(t.onCreate())}),m(10),p(11,"translate"),n()(),a(12,"span",7),p(13,"translate"),p(14,"isAuthorized"),T(15,pi,4,9,"button",8),n(),a(16,"perun-web-apps-debounce-filter",9),h("filter",function(v){return u(s),f(t.applyFilter(v))}),n(),I(17,di,1,0,"ng-template",null,0,M),a(19,"div",10),I(20,mi,1,7,"perun-web-apps-facilities-list",11),n()()}if(r&2){let s=F(18);o(3),c("ngStyle",Ee(28,ci)),o(),S(" ",d(5,17,"FACILITY_MANAGEMENT.TITLE")," "),o(3),c("matTooltip",He(d(8,19,"FACILITY_MANAGEMENT.CREATE_DISABLED")))("matTooltipDisabled",t.createAuth),o(2),c("disabled",!t.createAuth),o(),S(" ",d(11,21,"FACILITY_MANAGEMENT.CREATE")," "),o(2),c("matTooltip",He(d(13,23,"FACILITY_MANAGEMENT.DELETE_PERMISSION_HINT")))("matTooltipDisabled",t.selection.selected.length===0||ze(14,25,qe(29,Kt,t.selection.selected[0]==null?null:t.selection.selected[0].facility),"deleteFacility_Facility_Boolean_policy"))("matTooltipPosition","below"),o(3),R(t.deleteAuth?15:-1),o(),c("autoFocus",!0)("placeholder","FACILITY_MANAGEMENT.FILTER_PLACEHOLDER")("linkGlobalSearch",!0),o(4),c("perunWebAppsLoader",t.loading)("perunWebAppsLoaderIndicator",s)}},dependencies:[w,nt,W,k,ft,ut,kt,Z,Pt,jt,J,L,D,st,Y,x,wt],styles:[".icon-scale[_ngcontent-%COMP%]{transform:scale(1.7);margin-left:.5rem;margin-top:-.4rem;margin-right:.9rem}"]})}}return i})();function ui(i,C){i&1&&b(0,"perun-web-apps-loading-dialog")}function fi(i,C){i&1&&(a(0,"mat-error"),m(1),p(2,"translate"),n()),i&2&&(o(),S(" ",d(2,1,"DIALOGS.NAME_SPACE_ERROR")," "))}function hi(i,C){i&1&&(a(0,"mat-error"),m(1),p(2,"translate"),n()),i&2&&(o(),S(" ",d(2,1,"DIALOGS.CREATE_RESOURCE.INCORRECT_NAME")," "))}function _i(i,C){if(i&1){let e=A();a(0,"div")(1,"h1",2),m(2),p(3,"translate"),n(),a(4,"div",3)(5,"perun-web-apps-vo-search-select",4),h("voSelected",function(t){u(e);let s=_();return f(s.selectedVo=t)}),n(),a(6,"mat-form-field")(7,"mat-label"),m(8),p(9,"translate"),n(),b(10,"input",5),T(11,fi,3,3,"mat-error"),T(12,hi,3,3,"mat-error"),n(),a(13,"mat-form-field")(14,"mat-label"),m(15),p(16,"translate"),n(),b(17,"input",6),a(18,"mat-error"),m(19),p(20,"translate"),n()()(),a(21,"div",7)(22,"button",8),h("click",function(){u(e);let t=_();return f(t.onCancel())}),m(23),p(24,"translate"),n(),a(25,"button",9),h("click",function(){u(e);let t=_();return f(t.onSubmit())}),m(26),p(27,"translate"),n()()()}if(i&2){let e=_();o(2),S(" ",d(3,14,"DIALOGS.CREATE_RESOURCE.TITLE")," "),o(3),c("vos",e.vos)("disableAutoSelect",!0)("required",!0),o(3),y(d(9,16,"DIALOGS.CREATE_RESOURCE.NAME")),o(2),c("formControl",e.nameCtrl),o(),R(e.nameCtrl.errors!=null&&e.nameCtrl.errors.spaceName?11:-1),o(),R(e.nameCtrl.errors!=null&&e.nameCtrl.errors.spaceName?-1:12),o(3),y(d(16,18,"DIALOGS.CREATE_RESOURCE.DESCRIPTION")),o(2),c("formControl",e.descriptionCtrl),o(2),S(" ",d(20,20,"DIALOGS.CREATE_RESOURCE.FILL_DESCRIPTION")," "),o(4),S(" ",d(24,22,"DIALOGS.CREATE_RESOURCE.CANCEL")," "),o(2),c("disabled",e.nameCtrl.invalid||e.descriptionCtrl.invalid||e.selectedVo===null||e.loading),o(),S(" ",d(27,24,"DIALOGS.CREATE_RESOURCE.CREATE")," ")}}var Zt=(()=>{class i{constructor(e,r,t,s,g,v){this.dialogRef=e,this.data=r,this.notificator=t,this.voService=s,this.translate=g,this.resourcesManager=v,this.vos=[],this.selectedVo=null,g.get("DIALOGS.CREATE_RESOURCE.SUCCESS").subscribe(O=>this.successMessage=O)}ngOnInit(){this.loading=!0,this.theme=this.data.theme,this.voService.getAllVos().subscribe({next:e=>{this.vos=e,this.loading=!1},error:()=>this.loading=!1}),this.nameCtrl=new N("",[ve.required,ve.pattern(".*[\\S]+.*"),Ge()]),this.descriptionCtrl=new N("")}onSubmit(){this.loading=!0,this.resourcesManager.createResource(this.selectedVo.id,this.data.facilityId,this.nameCtrl.value,this.descriptionCtrl.value).subscribe({next:()=>{this.notificator.showSuccess(this.successMessage),this.loading=!1,this.dialogRef.close(!0)},error:()=>this.loading=!1})}onCancel(){this.dialogRef.close(!1)}static{this.\u0275fac=function(r){return new(r||i)(l(pe),l(de),l(z),l(St),l(ae),l(Ve))}}static{this.\u0275cmp=E({type:i,selectors:[["app-create-resource-dialog"]],decls:4,vars:5,consts:[["spinner",""],[4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],["mat-dialog-title",""],["mat-dialog-content","",1,"dialog-container"],["data-cy","create-resource-select-vo",3,"voSelected","vos","disableAutoSelect","required"],["matInput","","data-cy","create-resource-name-input","required","",3,"formControl"],["matInput","",3,"formControl"],["mat-dialog-actions",""],["mat-stroked-button","",1,"ms-auto",3,"click"],["data-cy","create-resource-dialog-button","color","accent","mat-flat-button","",1,"ms-2",3,"click","disabled"]],template:function(r,t){if(r&1&&(I(0,ui,1,0,"ng-template",null,0,M),a(2,"div"),I(3,_i,28,26,"div",1),n()),r&2){let s=F(1);o(2),ie(Ie("",t.theme," position-relative")),o(),c("perunWebAppsLoader",t.loading)("perunWebAppsLoaderIndicator",s)}},dependencies:[w,W,k,U,G,j,Me,Le,De,ne,Re,re,we,oe,je,Pe,Ne,Be,xe,D,L,Ue,x],styles:[".long-input[_ngcontent-%COMP%]{width:100%}"]})}}return i})();function gi(i,C){if(i&1){let e=A();a(0,"button",10),h("click",function(){u(e);let t=_();return f(t.createResource())}),m(1),p(2,"translate"),n()}i&2&&(o(),S(" ",d(2,1,"FACILITY_DETAIL.RESOURCES.CREATE")," "))}function Ci(i,C){if(i&1){let e=A();a(0,"button",11),h("click",function(){u(e);let t=_();return f(t.removeResource())}),m(1),p(2,"translate"),n()}if(i&2){let e=_();c("disabled",e.selected.selected.length===0||e.loading),o(),S(" ",d(2,2,"FACILITY_DETAIL.RESOURCES.DELETE")," ")}}function vi(i,C){i&1&&b(0,"perun-web-apps-loading-table")}function Si(i,C){if(i&1&&b(0,"perun-web-apps-resources-list",12),i&2){let e=_();c("tableId",e.tableId)("loading",e.loading)("filterValue",e.filterValue)("resources",e.resources)("selection",e.selected)("cachedSubject",e.cachedSubject)("disableRouting",!e.routeAuth)("displayColumns",e.displayedColumns)}}var Do=(()=>{class i{static{this.id="FacilityResourcesComponent"}constructor(e,r,t,s,g,v,O,ge){this.dialog=e,this.facilitiesManager=r,this.servicesManager=t,this.authResolver=s,this.entityStorageService=g,this.cd=v,this.cacheHelperService=O,this.destroyRef=ge,this.resources=[],this.selected=new Fe(!0,[],!0,(We,Ye)=>We.id===Ye.id),this.cachedSubject=new P(!0),this.emptyService={id:-1,beanName:"Service",name:"All"},this.services=[this.emptyService],this.selectedService=this.emptyService,this.filterValue="",this.tableId=Mt,this.displayedColumns=["id","vo","facility","description"]}ngOnInit(){this.loading=!0,this.facility=this.entityStorageService.getEntity(),this.setAuthRights(),this.servicesManager.getAssignedServices(this.facility.id).subscribe(e=>{this.services=[this.emptyService].concat(e),this.refreshTable()}),this.loadResourcesForFacility(),this.cacheHelperService.refreshComponentCachedData().pipe(K(this.destroyRef)).subscribe(e=>{e===i.id&&this.refreshTable()})}ngAfterViewInit(){this.cd.detectChanges()}removeResource(){let e=q();e.width="450px",e.data={theme:"facility-theme",resources:this.selected.selected},this.dialog.open(Yt,e).afterClosed().subscribe(t=>{t&&this.refreshTable()})}refreshTable(){this.loading=!0,this.selectedService.id===-1?this.loadResourcesForFacility():this.facilitiesManager.getAssignedRichResourcesForFacilityAndService(this.facility.id,this.selectedService.id).subscribe(e=>{this.resources=e,this.selected.clear(),this.cachedSubject.next(!0),this.setAuthRights(),this.loading=!1})}setAuthRights(){this.addAuth=this.authResolver.isAuthorized("createResource_Resource_Vo_Facility_policy",[this.facility]),this.removeAuth=this.authResolver.isAuthorized("deleteResource_Resource_policy",[this.facility]),this.displayedColumns=this.removeAuth?["select","id","name","vo","description"]:["id","name","vo","description"],this.resources.length!==0&&(this.routeAuth=this.authResolver.isAuthorized("getRichResourceById_int_policy",[this.facility,this.resources[0]]))}applyFilter(e){this.filterValue=e,this.refreshTable()}createResource(){let e=q();e.width="1350px",e.data={facilityId:this.facility.id,theme:"facility-theme"},this.dialog.open(Zt,e).afterClosed().subscribe(t=>{t&&this.refreshTable()})}serviceSelected(e){this.selectedService=e,this.refreshTable()}loadResourcesForFacility(){this.facilitiesManager.getAssignedRichResourcesForFacility(this.facility.id).subscribe(e=>{this.resources=e,this.selected.clear(),this.cachedSubject.next(!0),this.setAuthRights(),this.loading=!1})}static{this.\u0275fac=function(r){return new(r||i)(l(me),l(V),l(Oe),l(H),l($),l(Te),l(X),l(B))}}static{this.\u0275cmp=E({type:i,selectors:[["app-facility-resources"]],hostVars:2,hostBindings:function(r,t){r&2&&te("router-component",t.true)},decls:14,vars:10,consts:[["spinner",""],[1,"page-subtitle"],[1,"align-elements"],[3,"refresh"],["mat-flat-button","","color","accent","data-cy","create-resource-button",1,"me-2","action-button"],["mat-flat-button","","color","warn","data-cy","delete-resource-button",1,"me-2",3,"disabled"],[1,"search-select","me-2",3,"serviceSelected","services","service"],[1,"filter-field",3,"filter","placeholder"],[1,"position-relative","table-min-height"],[3,"tableId","loading","filterValue","resources","selection","cachedSubject","disableRouting","displayColumns",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],["mat-flat-button","","color","accent","data-cy","create-resource-button",1,"me-2","action-button",3,"click"],["mat-flat-button","","color","warn","data-cy","delete-resource-button",1,"me-2",3,"click","disabled"],[3,"tableId","loading","filterValue","resources","selection","cachedSubject","disableRouting","displayColumns"]],template:function(r,t){if(r&1){let s=A();a(0,"div")(1,"h1",1),m(2),p(3,"translate"),n(),a(4,"div",2)(5,"perun-web-apps-refresh-button",3),h("refresh",function(){return u(s),f(t.refreshTable())}),n(),T(6,gi,3,3,"button",4),T(7,Ci,3,4,"button",5),a(8,"perun-web-apps-service-search-select",6),h("serviceSelected",function(v){return u(s),f(t.serviceSelected(v))}),n(),a(9,"perun-web-apps-debounce-filter",7),h("filter",function(v){return u(s),f(t.applyFilter(v))}),n()(),I(10,vi,1,0,"ng-template",null,0,M),a(12,"div",8),I(13,Si,1,8,"perun-web-apps-resources-list",9),n()()}if(r&2){let s=F(11);o(2),y(d(3,8,"FACILITY_DETAIL.RESOURCES.TITLE")),o(4),R(t.addAuth?6:-1),o(),R(t.removeAuth?7:-1),o(),c("services",t.services)("service",t.selectedService),o(),c("placeholder","SHARED_LIB.PERUN.COMPONENTS.RESOURCES_LIST.TABLE_SEARCH"),o(4),c("perunWebAppsLoader",t.loading)("perunWebAppsLoaderIndicator",s)}},dependencies:[w,W,k,J,Z,D,ke,Y,Bt,L,x],styles:[".search-select[_ngcontent-%COMP%]{min-width:325px}.filter-field[_ngcontent-%COMP%]{min-width:250px}.align-elements[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;align-items:baseline}"]})}}return i})();var bi=()=>["id","vo","name","description"],yi=(i,C)=>C.id;function Ai(i,C){if(i&1&&(a(0,"mat-option",6),m(1),n()),i&2){let e=C.$implicit;c("value",e.id),o(),S(" ",e.name," ")}}function Ii(i,C){i&1&&b(0,"perun-web-apps-loading-table")}function Ei(i,C){if(i&1&&b(0,"perun-web-apps-groups-list",10),i&2){let e=_();c("loading",e.loading)("displayColumns",Ee(7,bi))("groups",e.groupsToShow)("disableMembers",!1)("filter",e.filterValue)("groupsToDisableRouting",e.groupsWithoutRouteAuth)("tableId",e.tableId)}}var Zo=(()=>{class i{static{this.id="FacilityAllowedGroupsComponent"}constructor(e,r,t,s,g){this.facilityManager=e,this.authResolver=r,this.entityStorageService=t,this.cacheHelperService=s,this.destroyRef=g,this.groups=[],this.filterValue="",this.selected="all",this.groupsToShow=this.groups,this.tableId=Dt,this.groupsWithoutRouteAuth=new Set}ngOnInit(){this.loading=!0,this.facility=this.entityStorageService.getEntity(),this.facilityManager.getAllowedVos(this.facility.id).subscribe(e=>{this.vos=e,this.refreshTable()}),this.cacheHelperService.refreshComponentCachedData().pipe(K(this.destroyRef)).subscribe(e=>{e===i.id&&this.refreshTable()})}showGroup(){this.selected!=="all"?this.groupsToShow=this.groups.filter(e=>e.voId===parseInt(this.selected,10)):this.groupsToShow=this.groups}refreshTable(){this.loading=!0,this.groups=[],this.facilityManager.getAllowedGroups(this.facility.id).subscribe(e=>{this.groups=e,this.groupsToShow=this.groups,this.setAuthRights(e),this.loading=!1}),this.vos&&this.vos.length===0&&(this.loading=!1)}setAuthRights(e){e.forEach(r=>{this.authResolver.isAuthorized("getGroupById_int_policy",[r])||this.groupsWithoutRouteAuth.add(r.id)})}applyFilter(e){this.filterValue=e}static{this.\u0275fac=function(r){return new(r||i)(l(V),l(H),l($),l(X),l(B))}}static{this.\u0275cmp=E({type:i,selectors:[["app-facility-allowed-groups"]],hostVars:2,hostBindings:function(r,t){r&2&&te("router-component",t.true)},inputs:{groups:"groups"},decls:20,vars:13,consts:[["spinner",""],[1,"page-subtitle"],[3,"refresh"],[1,"me-2"],[3,"selectionChange","valueChange","value"],["value","all"],[3,"value"],[3,"filter","placeholder"],[1,"position-relative","table-min-height"],[3,"loading","displayColumns","groups","disableMembers","filter","groupsToDisableRouting","tableId",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[3,"loading","displayColumns","groups","disableMembers","filter","groupsToDisableRouting","tableId"]],template:function(r,t){if(r&1){let s=A();a(0,"div")(1,"h1",1),m(2),p(3,"translate"),n(),a(4,"perun-web-apps-refresh-button",2),h("refresh",function(){return u(s),f(t.refreshTable())}),n(),a(5,"mat-form-field",3)(6,"mat-label"),m(7),p(8,"translate"),n(),a(9,"mat-select",4),h("selectionChange",function(){return u(s),f(t.showGroup())}),Ae("valueChange",function(v){return u(s),ye(t.selected,v)||(t.selected=v),f(v)}),a(10,"mat-option",5),m(11),p(12,"translate"),n(),Q(13,Ai,2,2,"mat-option",6,yi),n()(),a(15,"perun-web-apps-debounce-filter",7),h("filter",function(v){return u(s),f(t.applyFilter(v))}),n(),I(16,Ii,1,0,"ng-template",null,0,M),a(18,"div",8),I(19,Ei,1,8,"perun-web-apps-groups-list",9),n()()}if(r&2){let s=F(17);o(2),y(d(3,7,"MENU_ITEMS.FACILITY.ALLOWED_GROUPS")),o(5),y(d(8,9,"FACILITY_DETAIL.ALLOWED_GROUPS.SHOW_VOS_GROUPS")),o(2),be("value",t.selected),o(2),y(d(12,11,"FACILITY_DETAIL.ALLOWED_GROUPS.ALL")),o(2),ee(t.vos),o(2),c("placeholder","FACILITY_DETAIL.ALLOWED_GROUPS.FILTER"),o(4),c("perunWebAppsLoader",t.loading)("perunWebAppsLoaderIndicator",s)}},dependencies:[w,U,G,j,ce,le,se,J,Z,D,Ot,L,Y,x],encapsulation:2})}}return i})();function Ti(i,C){if(i&1&&(a(0,"mat-option",17),m(1),p(2,"translate"),n()),i&2){let e=C.$implicit;c("value",e),o(),y(d(2,2,"CONSENTS.STATUS_"+e))}}function Ri(i,C){if(i&1){let e=A();a(0,"mat-form-field",15)(1,"mat-label"),m(2),p(3,"translate"),n(),a(4,"mat-select",16),h("closed",function(){u(e);let t=_(2);return f(t.consentStatusSelected())}),a(5,"mat-select-trigger"),m(6),n(),Q(7,Ti,3,4,"mat-option",17,ot),n()()}if(i&2){let e=_(2);o(2),y(d(3,3,"CONSENTS.STATUS")),o(2),c("formControl",e.consentStatuses),o(2),S(" ",e.displaySelectedStatuses()," "),o(),ee(e.consentStatusesList)}}function wi(i,C){if(i&1){let e=A();a(0,"div",6)(1,"div",9)(2,"mat-slide-toggle",10),Ae("ngModelChange",function(t){u(e);let s=_();return ye(s.showAllowed,t)||(s.showAllowed=t),f(t)}),h("change",function(){u(e);let t=_();return f(t.changeFilter())}),m(3),p(4,"translate"),n(),a(5,"span",11),m(6),p(7,"translate"),n()(),a(8,"div",2)(9,"perun-web-apps-vo-search-select",12),h("voSelected",function(t){u(e);let s=_();return f(s.voSelected(t))}),n(),a(10,"perun-web-apps-resource-search-select",13),h("resourceSelected",function(t){u(e);let s=_();return f(s.resourceSelected(t))}),n(),a(11,"perun-web-apps-service-search-select",14),h("serviceSelected",function(t){u(e);let s=_();return f(s.serviceSelected(t))}),n(),T(12,Ri,9,5,"mat-form-field",15),n()()}if(i&2){let e=_();o(2),be("ngModel",e.showAllowed),o(),S(" ",d(4,14,"FACILITY_DETAIL.ALLOWED_USERS.FILTER_ALLOWED")," "),o(3),y(d(7,16,e.toggle_messages[e.showAllowed?1:0])),o(3),c("vos",e.vos)("vo",e.selectedVo)("disableAutoSelect",!0),o(),c("resources",e.filteredResources)("displayStatus",!1)("resource",e.selectedResource)("disableAutoSelect",!0),o(),c("services",e.filteredServices)("service",e.selectedService)("disableAutoSelect",!0),o(),R(e.globalForceConsents&&e.facilityForceConsents?12:-1)}}function Fi(i,C){i&1&&b(0,"perun-web-apps-loading-table")}function Mi(i,C){if(i&1){let e=A();a(0,"perun-web-apps-users-list",18),p(1,"async"),p(2,"async"),h("queryChanged",function(t){u(e);let s=_();return f(s.nextPage.next(t))})("downloadAll",function(t){u(e);let s=_();return f(s.downloadAll(t))}),n()}if(i&2){let e=_();c("loading",d(1,9,e.loading$))("routeToAdmin",e.routeAuth)("disableRouting",!e.routeAuth)("users",d(2,11,e.usersPage$))("filter",e.searchString)("tableId",e.tableId)("displayColumns",e.displayedColumns)("facilityId",e.facility.id)("resetPagination",e.resetPagination)}}var Ln=(()=>{class i{static{this.id="FacilityAllowedUsersComponent"}constructor(e,r,t,s,g,v,O,ge,We,Ye,Jt,Xt,Qt,ei){this.facilityService=e,this.serviceService=r,this.resourceService=t,this.authResolver=s,this.storeService=g,this.entityStorageService=v,this.consentService=O,this.translate=ge,this.cd=We,this.dialog=Ye,this.cacheHelperService=Jt,this.userManager=Xt,this.destroyRef=Qt,this.notificator=ei,this.attributes=[],this.searchString="",this.nextPage=new P({}),this.usersPage$=this.nextPage.pipe(tt(Ce=>this.userManager.getUsersPage({attrNames:this.attributes,query:{order:Ce.order,pageSize:Ce.pageSize,offset:Ce.offset,sortColumn:Ce.sortColumn,onlyAllowed:this.showAllowed,consentStatuses:this.selectedConsentStatuses,searchString:Ce.searchString,facilityId:this.facility.id,resourceId:this.selectedResource?.id,serviceId:this.selectedService?.id,voId:this.selectedVo?.id}})),it(()=>{setTimeout(()=>this.loadingSubject$.next(!1),200)}),et({data:[],totalCount:0,offset:0,pageSize:0})),this.loadingSubject$=new P(!1),this.resetPagination=new P(!1),this.loading$=Qe(this.loadingSubject$,this.nextPage.pipe(Xe(()=>!0))),this.showAllowed=!0,this.resources=[],this.filteredResources=[],this.vos=[],this.services=[],this.filteredServices=[],this.consentStatusesList=["UNSIGNED","GRANTED","REVOKED"],this.selectedConsentStatuses=[],this.forceConsentsDisplayColumns=["id","name","email","logins","organization","consentStatus"],this.displayedColumns=["id","name","email","logins","organization"],this.tableId=Lt,this.toggle_messages=["FACILITY_DETAIL.ALLOWED_USERS.FILTER_ASSIGNED_MSG","FACILITY_DETAIL.ALLOWED_USERS.FILTER_ALLOWED_MSG"],this.advancedFilter=!1}ngOnInit(){this.consentStatuses=new N(this.selectedConsentStatuses),this.attributes=[$e.USER_DEF_ORGANIZATION,$e.USER_DEF_PREFERRED_MAIL],this.attributes=this.attributes.concat(this.storeService.getLoginAttributeNames()),this.facility=this.entityStorageService.getEntity(),this.globalForceConsents=this.storeService.getProperty("enforce_consents"),this.consentService.getConsentHubByFacility(this.facility.id).subscribe(e=>{this.facilityForceConsents=e.enforceConsents,this.globalForceConsents&&this.facilityForceConsents&&(this.displayedColumns=this.forceConsentsDisplayColumns)}),this.routeAuth=this.authResolver.isPerunAdminOrObserver(),this.loadFilters(),this.changeFilter(),this.cacheHelperService.refreshComponentCachedData().pipe(K(this.destroyRef)).subscribe(e=>{e===i.id&&this.refresh()})}changeFilter(){this.filtersCount=this.showAllowed?1:0,this.selectedVo&&(this.filtersCount+=1),this.selectedResource&&(this.filtersCount+=1),this.selectedService&&(this.filtersCount+=1),this.selectedConsentStatuses.length>0&&(this.filtersCount+=1),this.cd.detectChanges(),this.refresh()}clearFilters(){let e=this.advancedFilter;this.advancedFilter=!1,this.showAllowed=!1,this.selectedVo=void 0,this.selectedResource=void 0,this.selectedService=void 0,this.selectedConsentStatuses=[],this.consentStatuses.setValue(this.selectedConsentStatuses),this.filtersCount=0,this.voSelected(this.selectedVo),this.resourceSelected(this.selectedResource),this.serviceSelected(this.selectedService),this.cd.detectChanges(),this.advancedFilter=e}loadFilters(){this.facilityService.getAllowedVos(this.facility.id).subscribe(e=>{this.vos=e,this.facilityService.getAssignedResourcesForFacility(this.facility.id).subscribe(r=>{this.resources=r,this.filteredResources=this.resources,this.selectedVo&&(this.filteredResources=this.resources.filter(t=>t.voId===this.selectedVo.id))}),this.serviceService.getAssignedServices(this.facility.id).subscribe(r=>{this.services=r,this.selectedResource&&this.resourceService.getAssignedServicesToResource(this.selectedResource.id).subscribe(t=>{this.filteredServices=t}),this.cd.detectChanges()})})}refresh(){this.loadFilters(),this.resetPagination.next(!0),this.nextPage.next(this.nextPage.value)}applyFilter(e){this.searchString=e,this.refresh()}voSelected(e){this.selectedVo=e,this.selectedResource=void 0,this.selectedService=void 0,this.changeFilter()}resourceSelected(e){this.selectedResource=e,this.services=[],this.filteredServices=[],this.selectedService=null,this.changeFilter()}serviceSelected(e){this.selectedService=e,this.changeFilter()}consentStatusSelected(){this.selectedConsentStatuses=this.consentStatuses.value,this.changeFilter()}displaySelectedStatuses(){if(this.selectedConsentStatuses.length===this.consentStatusesList.length)return"ALL";let e=this.consentStatuses.value;return e?`${this.translate.instant("CONSENTS.STATUS_"+e[0])}  ${e.length>1?"(+"+(e.length-1).toString()+" "+(e.length===2?"other)":"others)"):""}`:""}downloadAll(e){let r=this.nextPage.getValue(),t=q();t.width="500px";let s=this.dialog.open(Ft,t),g=this.userManager.getUsersPage({attrNames:this.attributes,query:{order:r.order,pageSize:e.length,offset:0,sortColumn:r.sortColumn,searchString:r.searchString,onlyAllowed:this.showAllowed,consentStatuses:this.selectedConsentStatuses,facilityId:this.facility.id,resourceId:this.selectedResource?.id,serviceId:this.selectedService?.id,voId:this.selectedVo?.id}}).subscribe({next:v=>{s.close(),Rt(Tt(e.convertToExport(v.data),this.displayedColumns,e.getDataForColumnFun),e.format)},error:v=>{this.notificator.showRPCError(v),s.close()}});s.afterClosed().subscribe(()=>{g&&g.unsubscribe()})}static{this.\u0275fac=function(r){return new(r||i)(l(V),l(Oe),l(Ve),l(H),l(yt),l($),l(Ct),l(gt),l(Te),l(me),l(X),l(vt),l(B),l(z))}}static{this.\u0275cmp=E({type:i,selectors:[["app-facility-allowed-users"]],decls:14,vars:11,consts:[["spinner",""],[1,"page-subtitle"],[1,"filters"],[1,"me-2",3,"refresh"],[1,"me-2","filter",3,"filter","placeholder"],[3,"changeAdvancedFilter","clearFilters","advancedFilter","filtersCount"],[1,"advanced-filter"],[1,"position-relative","table-min-height"],[3,"loading","routeToAdmin","disableRouting","users","filter","tableId","displayColumns","facilityId","resetPagination","queryChanged","downloadAll",4,"perunWebAppsLoader","perunWebAppsLoaderIndicator"],[1,"toggle","filters"],["labelPosition","before",1,"me-2",3,"ngModelChange","change","ngModel"],[1,"text-muted"],[1,"search-select",3,"voSelected","vos","vo","disableAutoSelect"],[1,"search-select",3,"resourceSelected","resources","displayStatus","resource","disableAutoSelect"],[1,"search-select",3,"serviceSelected","services","service","disableAutoSelect"],[1,"search-select"],["multiple","",3,"closed","formControl"],[3,"value"],[3,"queryChanged","downloadAll","loading","routeToAdmin","disableRouting","users","filter","tableId","displayColumns","facilityId","resetPagination"]],template:function(r,t){if(r&1){let s=A();a(0,"div")(1,"h1",1),m(2),p(3,"translate"),n(),a(4,"div",2)(5,"perun-web-apps-refresh-button",3),h("refresh",function(){return u(s),f(t.refresh())}),n(),a(6,"perun-web-apps-debounce-filter",4),h("filter",function(v){return u(s),f(t.applyFilter(v))}),n(),a(7,"perun-web-apps-advanced-filter",5),h("changeAdvancedFilter",function(v){return u(s),f(t.advancedFilter=v)})("clearFilters",function(){return u(s),f(t.clearFilters())}),n()(),T(8,wi,13,18,"div",6),I(9,Fi,1,0,"ng-template",null,0,M),a(11,"div",7),I(12,Mi,3,13,"perun-web-apps-users-list",8),p(13,"async"),n()()}if(r&2){let s=F(10);o(2),y(d(3,7,"FACILITY_DETAIL.ALLOWED_USERS.TITLE")),o(4),c("placeholder","FACILITY_DETAIL.ALLOWED_USERS.FILTER"),o(),c("advancedFilter",t.advancedFilter)("filtersCount",t.filtersCount),o(),R(t.advancedFilter?8:-1),o(4),c("perunWebAppsLoader",d(13,9,t.loading$))("perunWebAppsLoaderIndicator",s)}},dependencies:[w,U,G,j,ce,le,mt,se,It,At,ne,re,oe,ct,lt,J,Z,D,Ut,Ue,Nt,ke,Y,Gt,L,at,x],styles:[".filters[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;align-items:baseline}.filter[_ngcontent-%COMP%]{min-width:350px}.search-select[_ngcontent-%COMP%]{width:32%;margin-right:20px;margin-top:30px}.toggle[_ngcontent-%COMP%]{display:flex;flex-direction:column}.advanced-filter[_ngcontent-%COMP%]{border:1px solid lightgray;padding:15px}"]})}}return i})();export{$t as a,kr as b,Do as c,Zo as d,Ln as e};
