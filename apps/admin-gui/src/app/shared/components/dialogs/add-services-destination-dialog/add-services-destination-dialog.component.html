<ng-template #spinner>
  <perun-web-apps-loading-dialog></perun-web-apps-loading-dialog>
</ng-template>
<div class="{{data.theme}} position-relative">
  <div *perunWebAppsLoader="loading; indicator: spinner">
    <h1 mat-dialog-title>{{'DIALOGS.ADD_SERVICE_DESTINATION.TITLE' | translate}}</h1>
    <div class="dialog-container" mat-dialog-content>
      <div class="font-italic">{{'DIALOGS.ADD_SERVICE_DESTINATION.DESCRIPTION' | translate}}</div>
      <mat-form-field>
        <mat-label>{{'DIALOGS.ADD_SERVICE_DESTINATION.SERVICE' | translate}}</mat-label>
        <mat-select [formControl]="serviceControl" required>
          @if (services.length !== 0) {
            <mat-option
              value="all"
              >{{'DIALOGS.ADD_SERVICE_DESTINATION.SELECTION_ALL' | translate}}</mat-option
            >
          }
          @if (services.length === 0) {
            <mat-option
              value="noService"
              >{{'DIALOGS.ADD_SERVICE_DESTINATION.NO_SERVICE' | translate}}</mat-option
            >
          }
          @for (service of services; track service.id) {
            <mat-option [value]="service">
              {{service.name}}
            </mat-option>
          }
        </mat-select>
        @if (serviceControl.value === undefined) {
          <mat-error>
            {{'DIALOGS.ADD_SERVICE_DESTINATION.CHOOSE_SERVICE' | translate}}
          </mat-error>
        }
      </mat-form-field>
      <mat-checkbox (change)="getServices()" [(ngModel)]="servicesOnFacility">
        {{'DIALOGS.ADD_SERVICE_DESTINATION.IS_SERVICES_ONLY_ON_FACILITY' | translate}}
      </mat-checkbox>
      <mat-form-field>
        <mat-label>{{'DIALOGS.ADD_SERVICE_DESTINATION.TYPE' | translate}}</mat-label>
        <mat-select
          [(ngModel)]="selectedType"
          (selectionChange)="this.destinationControl.updateValueAndValidity()">
          @for (type of types; track type) {
            <mat-option [value]="type">
              {{getTypeForView(type)}}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      @if (!(selectedType === 'host' && useFacilityHost)) {
        <mat-form-field class="w-100">
          <mat-label>{{getTypeForView(selectedType)}}</mat-label>
          <input [formControl]="destinationControl" matInput required />
          @if (
            selectedType === 'host' && !useFacilityHost && destinationControl.hasError('required')
          ) {
            <mat-error>
              {{'DIALOGS.ADD_SERVICE_DESTINATION.REQUIRED_FIELD' | translate}}
            </mat-error>
          }
          @if (destinationControl.hasError('invalidDestination')) {
            <mat-error>
              {{'DIALOGS.ADD_SERVICE_DESTINATION.INVALID_DESTINATION' | translate}}
            </mat-error>
          }
        </mat-form-field>
      }

      @if (selectedType === 'host') {
        <mat-checkbox [(ngModel)]="useFacilityHost">
          {{'DIALOGS.ADD_SERVICE_DESTINATION.USE_FACILITY_HOST' | translate}}
        </mat-checkbox>
      }

      <mat-form-field>
        <mat-label>{{'DIALOGS.ADD_SERVICE_DESTINATION.PROPAGATION' | translate}}</mat-label>
        <mat-select [(ngModel)]="selectedPropagation">
          @for (propagation of propagations; track propagation) {
            <mat-option [value]="propagation">
              {{propagation}}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
      <div class="font-italic">
        {{'DIALOGS.ADD_SERVICE_DESTINATION.PROPAGATION_TYPE_' + selectedPropagation | translate}}
      </div>
    </div>
    <div mat-dialog-actions>
      <button (click)="onCancel()" class="ms-auto" mat-stroked-button>
        {{'DIALOGS.ADD_SERVICE_DESTINATION.CANCEL' | translate}}
      </button>
      <button
        (click)="onSubmit()"
        [disabled]="loading || invalidDestination() || serviceControl.invalid || serviceControl.value === 'noService'"
        class="ms-2"
        color="accent"
        mat-flat-button>
        {{'DIALOGS.ADD_SERVICE_DESTINATION.ADD' | translate}}
      </button>
    </div>
  </div>
</div>
