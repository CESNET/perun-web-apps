@if (assignableRules.length !== 0 && editable) {
  <button mat-flat-button color="accent" class="me-2 mt-2" (click)="addRole()">
    {{'ROLES.ADD'| translate}}
  </button>
}
@if (outerLoading) {
  <mat-spinner class="ms-auto me-auto"></mat-spinner>
}
<div class="mt-3">
  @if (!outerLoading && roles.size > 0) {
    <mat-accordion>
      @for (role of allRules; track role) {
        <mat-expansion-panel
          [expanded]="this.currentlyOpenPanel === role.roleName"
          (closed)="selection.clear(); selectedFacilities.clear(); onPanelClosed(role.roleName)"
          (opened)="selectedRole.next(role); onPanelOpen(role.roleName)"
          #panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <p class="mt-auto mb-auto">{{role | displayedRole}}</p>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <ng-template matExpansionPanelContent>
            @if (
              editable && role.roleName !== 'SELF' && role.roleName !== 'MEMBERSHIP' && role.roleName !== 'SPONSORSHIP'
            ) {
              <span
                matTooltip="{{'ROLES.REMOVE_DISABLED_TOOLTIP'| translate}}"
                matTooltipPosition="left"
                [matTooltipDisabled]="loading || (selection.selected.length === 0 && selectedFacilities.selected.length === 0) || !disableRemove">
                <button
                  (click)="openConfirmDialog(role)"
                  [disabled]="loading || (role.primaryObject === 'Facility' && (selectedFacilities.selected.length === 0 || disableRemove))
           ||  ( ['Vo', 'Group', 'Resource'].includes(role.primaryObject) && (selection.selected.length === 0 || disableRemove))"
                  mat-flat-button
                  color="warn"
                  class="mt-2">
                  {{'ROLES.REMOVE'| translate}}
                </button>
              </span>
            }
            @if (panel.expanded) {
              <div class="position-relative">
                @if (role.primaryObject === 'Vo' || role.roleName === 'MEMBERSHIP') {
                  <div class="mb-3">
                    @if (showDescription) {
                      <div>
                        {{('ROLES.' + role.roleName + '_VOS_' + entityType) | translate}}
                      </div>
                    }
                    <div class="position-relative table-min-height">
                      <perun-web-apps-vos-list
                        *perunWebAppsLoader="loading; indicator: spinner"
                        [loading]="loading"
                        [displayColumns]="role.roleName === 'MEMBERSHIP' ? ['id', 'name', 'shortName'] : (editable ? ['checkbox', 'id', 'name', 'shortName'] : ['id', 'name', 'shortName', 'authzGroup'])"
                        [vos]="vos | async"
                        [selection]="selection"
                        [authzVoNames]="voNames"
                        [voWithAuthzGroupPairs]="_complementaryObjectsWithAuthzGroups?.get(role.roleName)?.get('vo')"
                        [enableMasterCheckbox]="true">
                      </perun-web-apps-vos-list>
                    </div>
                  </div>
                }
                @if (role.primaryObject === 'Group' || role.roleName === 'MEMBERSHIP') {
                  <div class="mb-3">
                    @if (showDescription) {
                      <div>
                        {{('ROLES.' + role.roleName + '_GROUPS_' + entityType) | translate}}
                      </div>
                    }
                    <div class="position-relative table-min-height">
                      <perun-web-apps-groups-list
                        *perunWebAppsLoader="loading; indicator: spinner"
                        [loading]="loading"
                        [displayColumns]="role.roleName === 'MEMBERSHIP' ? ['id', 'vo', 'name', 'description'] : (editable ? ['select', 'id', 'vo', 'name', 'description'] : ['id', 'vo', 'name', 'description', 'authzGroup'])"
                        [groups]="groups | async"
                        [selection]="selection"
                        [authzVoNames]="voNames"
                        [groupWithAuthzGroupPairs]="_complementaryObjectsWithAuthzGroups?.get(role.roleName)?.get('group')">
                      </perun-web-apps-groups-list>
                    </div>
                  </div>
                }
                @if (role.primaryObject === 'Resource' || role.roleName === 'MEMBERSHIP') {
                  <div class="mb-3">
                    @if (showDescription) {
                      <div>
                        {{('ROLES.' + role.roleName + '_RESOURCES_' + entityType) | translate}}
                      </div>
                    }
                    <div class="position-relative table-min-height">
                      <perun-web-apps-resources-list
                        *perunWebAppsLoader="loading; indicator: spinner"
                        [resources]="resources | async"
                        [displayColumns]="role.roleName === 'MEMBERSHIP' ? ['id', 'name', 'vo', 'facility', 'description'] : (editable ? ['select', 'id', 'name', 'vo', 'facility', 'description'] : ['id', 'name', 'vo', 'facility', 'description', 'authzGroup'])"
                        [routingVo]="true"
                        [selection]="selection"
                        [authzVoNames]="voNames"
                        [loading]="loading"
                        [resourceWithAuthzGroupPairs]="_complementaryObjectsWithAuthzGroups?.get(role.roleName)?.get('resource')">
                      </perun-web-apps-resources-list>
                    </div>
                  </div>
                }
                @if (role.primaryObject === 'Facility' || role.roleName === 'MEMBERSHIP') {
                  <div class="mb-3">
                    @if (showDescription) {
                      <div>
                        {{('ROLES.' + role.roleName + '_FACILITIES_' + entityType) | translate}}
                      </div>
                    }
                    <div class="position-relative table-min-height">
                      <perun-web-apps-facilities-list
                        *perunWebAppsLoader="loading; indicator: spinner"
                        [loading]="loading"
                        [displayColumns]="role.roleName === 'MEMBERSHIP' ? ['id', 'name', 'description'] : (editable ? ['select', 'id', 'name', 'description'] : ['id', 'name', 'description', 'authzGroup'])"
                        [facilities]="facilities | async"
                        [selection]="selectedFacilities"
                        [authzVoNames]="voNames"
                        [facilityWithAuthzGroupPairs]="_complementaryObjectsWithAuthzGroups?.get(role.roleName)?.get('facility')"
                        [enableMasterCheckbox]="true">
                      </perun-web-apps-facilities-list>
                    </div>
                  </div>
                }
                @if (role.roleName === 'SPONSORSHIP') {
                  <div class="mb-3">
                    @if (showDescription) {
                      <div>
                        {{('ROLES.' + role.roleName + '_MEMBERS_' + entityType) | translate}}
                      </div>
                    }
                    <div class="position-relative table-min-height">
                      <perun-web-apps-members-list
                        *perunWebAppsLoader="loading; indicator: spinner"
                        [loading]="loading"
                        [displayedColumns]="['id', 'fullName', 'sponsored']"
                        [members]="members | async" />
                    </div>
                  </div>
                }
                @if (role.roleName === 'SELF') {
                  <div class="mb-3">
                    @if (showDescription) {
                      <div>
                        {{('ROLES.' + role.roleName + '_USERS_' + entityType) | translate}}
                      </div>
                    }
                    <div class="position-relative table-min-height">
                      <perun-web-apps-users-list
                        *perunWebAppsLoader="loading; indicator: spinner"
                        [loading]="loading"
                        [displayColumns]="['user', 'id', 'name']"
                        [disableRouting]="true"
                        [users]="users | async">
                      </perun-web-apps-users-list>
                    </div>
                  </div>
                }
              </div>
            }
          </ng-template>
        </mat-expansion-panel>
      }
    </mat-accordion>
  }
</div>

@if (!outerLoading && roles.size === 0) {
  <perun-web-apps-alert alert_type="warn">
    {{'ROLES.NO_ROLES' | translate}}
  </perun-web-apps-alert>
}

<ng-template #spinner>
  <div class="spinner-container">
    <mat-spinner></mat-spinner>
  </div>
</ng-template>
