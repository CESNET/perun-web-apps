<div class="user-theme">
  <h1 class="page-subtitle d-flex">
    <span>
      <mat-icon class="add-icon me-1">add_box</mat-icon>
      {{'IMPORT_PUBLICATIONS.TITLE' | translate}}
    </span>
  </h1>
  @if (!importDone) {
    <div>
      <div>
        <mat-form-field class="input-width-300 me-2">
          <mat-label>{{'IMPORT_PUBLICATIONS.EXT_PUB_SYSTEM' | translate}}</mat-label>
          <mat-select [formControl]="pubSystem" (closed)="selectPubSystem()">
            @for (publicationSystem of publicationSystems; track publicationSystem.id) {
              <mat-option
                class="group-theme"
                [value]="publicationSystem"
                >{{publicationSystem.friendlyName}}</mat-option
              >
            }
          </mat-select>
        </mat-form-field>
        <perun-web-apps-year-range [startYear]="startYear" [endYear]="endYear">
        </perun-web-apps-year-range>
        <button mat-stroked-button class="left-space" (click)="searchPublications()">
          <mat-icon iconPositionEnd>search</mat-icon>
          {{'IMPORT_PUBLICATIONS.SEARCH' | translate}}
        </button>
        <button
          mat-flat-button
          class="left-space"
          color="accent"
          [disabled]="selected.selected.length === 0 || loading"
          (click)="importPublications(selected.selected)">
          {{'IMPORT_PUBLICATIONS.IMPORT' | translate}}
        </button>
        <mat-checkbox class="mt-3 left-space" [(ngModel)]="userAsAuthor">
          {{'IMPORT_PUBLICATIONS.ADD_MYSELF' | translate}}
        </mat-checkbox>
      </div>
      @if (!firstSearchDone) {
        <perun-web-apps-alert alert_type="info">
          {{'IMPORT_PUBLICATIONS.INFO' | translate}}
        </perun-web-apps-alert>
      }
      @if (!loading) {
        <perun-web-apps-publications-list
          [publications]="publications"
          [displayColumns]="displayedColumns"
          [selection]="selected"
          [cachedSubject]="cachedSubject"
          [tableId]="tableId"
          [disabledRouting]="true"
          [allowAlert]="firstSearchDone">
        </perun-web-apps-publications-list>
      }
    </div>
  }
  @if (loading) {
    <mat-spinner class="ms-auto me-auto"></mat-spinner>
  }

  @if (importDone) {
    <div>
      <perun-web-apps-alert alert_type="info">
        {{'IMPORT_PUBLICATIONS.IMPORTED_INFO' | translate}}
      </perun-web-apps-alert>
      <mat-accordion>
        @for (publication of importedPublications; track publication.id; let i = $index) {
          <mat-expansion-panel [expanded]="indexExpanded === i">
            <mat-expansion-panel-header (click)="editPublication(i)">
              <mat-panel-title>
                {{publication.title}}
                @if (!this.completePublications.includes(publication.id)) {
                  <i>
                    {{'IMPORT_PUBLICATIONS.NOT_CHECKED' | translate}}
                  </i>
                }
                @if (this.completePublications.includes(publication.id)) {
                  <mat-icon color="accent" class="checked-icon">check_circle</mat-icon>
                }
              </mat-panel-title>
            </mat-expansion-panel-header>
            <perun-web-apps-publication-detail [publicationId]="publication.id">
            </perun-web-apps-publication-detail>
            <div class="fit-content">
              @if (!this.completePublications.includes(publication.id)) {
                <button
                  mat-flat-button
                  class="width-100"
                  color="accent"
                  (click)="completePublication(publication.id, i)">
                  {{'IMPORT_PUBLICATIONS.CHECKED_BUTTON' | translate}}
                </button>
              }
              @if (this.completePublications.includes(publication.id)) {
                <button
                  mat-stroked-button
                  class="width-100"
                  (click)="incompletePublication(publication.id)">
                  {{'IMPORT_PUBLICATIONS.NOT_CHECKED_BUTTON' | translate}}
                </button>
              }
            </div>
          </mat-expansion-panel>
        }
      </mat-accordion>
      <div class="right-button">
        @if (this.completePublications.length !== this.importedPublications.length) {
          <button
            mat-flat-button
            class="width-100"
            color="accent"
            (click)="completeAllPublications()">
            {{'IMPORT_PUBLICATIONS.CHECK_ALL' | translate}}
          </button>
        }
      </div>
      @if (this.completePublications.length === this.importedPublications.length) {
        <div
          class="right-button"
          matTooltip="{{'IMPORT_PUBLICATIONS.SUBMIT_TOOLTIP' | translate}}"
          [matTooltipPosition]="'above'"
          [matTooltipDisabled]="this.completePublications.length === this.importedPublications.length">
          <button mat-flat-button class="ms-2" color="accent" (click)="onSubmit()">
            {{'IMPORT_PUBLICATIONS.FINISH' | translate}}
          </button>
        </div>
      }
    </div>
  }
</div>
